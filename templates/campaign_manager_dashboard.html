<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×× ×”×œ ×§××¤×™×™×Ÿ - × ×™×”×•×œ ×œ×™×“×™×</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #1e293b;
            font-size: 2em;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }
        
        .email-status {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 15px;
            border-radius: 8px;
            margin: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .email-status.enabled {
            background: #dcfce7;
            border-color: #10b981;
            color: #065f46;
        }
        
        .sync-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .sync-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .sync-header h2 {
            color: #1e293b;
            font-size: 1.5em;
        }
        
        .btn-sync-all {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);
        }
        
        .btn-sync-all:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(16, 185, 129, 0.4);
        }
        
        .btn-sync-all:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-add-lead {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
            margin-left: 10px;
        }
        
        .btn-add-lead:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.4);
        }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #374151; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #10b981; }
        .btn-cancel { background: #6b7280; }
        
        .campaigns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .campaign-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        
        .campaign-card:hover {
            border-color: #10b981;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .campaign-info h3 {
            color: #1e293b;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .campaign-info p {
            color: #64748b;
            font-size: 0.9em;
        }
        
        .btn-sync {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .btn-sync:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        
        .btn-sync:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 16px; width: 90%; max-width: 600px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { font-size: 1.5rem; margin-bottom: 20px; color: #10b981; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn-modal { padding: 10px 20px; font-size: 14px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; }
        
        /* Sync Result Modal styles */
        .result-box { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin: 15px 0; font-family: 'Courier New', monospace; font-size: 14px; white-space: pre-wrap; user-select: text; max-height: 400px; overflow-y: auto; }
        .result-success { border-color: #10b981; background: #ecfdf5; }
        .result-error { border-color: #ef4444; background: #fef2f2; }
        .copy-btn { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; margin-top: 10px; }
        .copy-btn:hover { background: #2563eb; }
        .copy-btn:active { background: #1d4ed8; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header at TOP with v3.30 -->
        <div class="header">
            <h1>ğŸ¯ <span data-i18n="page_title">×× ×”×œ ×§××¤×™×™×Ÿ - × ×™×”×•×œ ×œ×™×“×™×</span> <span style="font-size:0.6em; opacity:0.8;">{{ version }}</span></h1>
            <div class="user-info">
                <button class="logout-btn" onclick="toggleLanguage()" id="langToggleBtn" style="background: #6366f1; margin-left: 10px; min-width: 50px;">
                    EN
                </button>
                <div class="user-badge">
                    {{ session.get('full_name', session.get('username')) }}
                    <span data-i18n="campaign_manager">(×× ×”×œ ×§××¤×™×™×Ÿ)</span>
                </div>
                <button class="logout-btn" onclick="window.location.href='/admin/campaigns'" style="background: #10b981; margin-left: 10px;">
                    ğŸ¯ <span data-i18n="manage_campaigns">× ×™×”×•×œ ×§××¤×™×™× ×™×</span>
                </button>
                <button class="logout-btn" onclick="window.location.href='/logout'">
                    ğŸšª <span data-i18n="logout">×™×¦×™××”</span>
                </button>
            </div>
        </div>
        
        <!-- Sync Campaigns Section - UPDATED WITH SYNC ALL BUTTON -->
        <div class="sync-section">
            <div class="sync-header">
                <h2>ğŸ”„ <span data-i18n="sync_campaigns_title">×¡× ×›×¨×•×Ÿ ×§××¤×™×™× ×™× ×-Google Sheets</span></h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn-add-lead" onclick="syncAllCampaigns()" style="background: #10b981; font-weight: bold;">
                        ğŸ”„ <span data-i18n="sync_all_campaigns">×¡× ×›×¨×Ÿ ××ª ×›×œ ×”×§××¤×™×™× ×™×</span>
                    </button>
                    <button class="btn-add-lead" onclick="openAddLeadModal()">
                        â• <span data-i18n="add_lead_manual">×”×•×¡×£ ×œ×™×“ ×™×“× ×™×ª</span>
                    </button>
                </div>
            </div>
            <div id="campaignsGrid" class="campaigns-grid">
                <p style="text-align: center; color: #64748b;" data-i18n="loading_campaigns">×˜×•×¢×Ÿ ×§××¤×™×™× ×™×...</p>
            </div>
        </div>
        
        <!-- Email Notification Status -->
        <div class="email-status" id="email-status">
            ï¿½ ×”×ª×¨××•×ª ××™××™×™×œ: ×‘×•×“×§ ×”×’×“×¨×•×ª...
        </div>

        <!-- Quick Actions Bar for Campaign Manager -->
        <div style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h3 style="margin: 0 0 5px 0; color: #1e293b;">âš¡ <span data-i18n="quick_actions">×¤×¢×•×œ×•×ª ××”×™×¨×•×ª</span></h3>
                    <p style="margin: 0; color: #64748b; font-size: 14px;" data-i18n="quick_actions_desc">×©×œ×— ×ª×–×›×•×¨×•×ª ×œ××©×ª××©×™× ×¢×œ ×œ×™×“×™× ×©×”×•×§×¦×• ×œ×”×</p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="quickSelectedCount" style="display: none; font-weight: 600; color: #3b82f6; padding: 8px 15px; background: #eff6ff; border-radius: 8px;">
                        <span id="quickSelectedNumber">0</span> <span data-i18n="selected">× ×‘×—×¨×•</span>
                    </span>
                    <button onclick="window.UnifiedLeadManager && window.UnifiedLeadManager.sendReminders()"
                            style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3); transition: all 0.2s;"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(59, 130, 246, 0.4)'"
                            onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 6px rgba(59, 130, 246, 0.3)'"
                            data-i18n-title="send_reminder_tooltip">
                        â° <span data-i18n="send_reminder_selected">×©×œ×— ×ª×–×›×•×¨×ª ×œ×œ×™×“×™× × ×‘×—×¨×™×</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Include Unified Lead Manager Component -->
        {% include 'unified_lead_manager.html' %}
        
        <!-- Include User Management Component for Campaign Managers -->
        {% include 'user_management_component.html' %}
    </div>

    <!-- Add Lead Modal -->
    <div id="addLeadModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header">â• ×”×•×¡×£ ×œ×™×“ ×™×“× ×™×ª</h2>
            <form id="addLeadForm">
                <div class="form-group">
                    <label>×œ×§×•×— <span style="color:red;">*</span></label>
                    <select id="addLeadCustomerId" required>
                        <option value="1" selected>×œ×§×•×— #1</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×©× ×§××¤×™×™×Ÿ <span style="color:red;">*</span></label>
                    <select id="addLeadCampaignName" required>
                        <option value="">×‘×—×¨ ×§××¤×™×™×Ÿ...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×©× ××œ× <span style="color:red;">*</span></label>
                    <input type="text" id="addLeadName" placeholder="×©× ×”×œ×™×“" required>
                </div>
                <div class="form-group">
                    <label>×˜×œ×¤×•×Ÿ <span style="color:red;">*</span></label>
                    <input type="text" id="addLeadPhone" placeholder="972501234567">
                </div>
                <div class="form-group">
                    <label>××™××™×™×œ</label>
                    <input type="email" id="addLeadEmail" placeholder="example@gmail.com">
                </div>
                <div class="form-group">
                    <label>×¡×˜×˜×•×¡</label>
                    <select id="addLeadStatus">
                        <option value="new">×—×“×©</option>
                        <option value="contacted">× ×•×¦×¨ ×§×©×¨</option>
                        <option value="qualified">××ª××™×</option>
                        <option value="converted">×”×•××¨</option>
                        <option value="lost">××‘×•×“</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×”×¢×¨×•×ª</label>
                    <input type="text" id="addLeadNotes" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª...">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-modal btn-cancel" onclick="closeAddLeadModal()">×‘×™×˜×•×œ</button>
                    <button type="submit" class="btn-modal">×”×•×¡×£ ×œ×™×“</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Sync Configuration Modal -->
    <div id="syncConfigModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h2 class="modal-header">âš™ï¸ ×”×’×“×¨×•×ª ×¡× ×›×¨×•×Ÿ</h2>
            <form id="syncConfigForm">
                <input type="hidden" id="syncCampaignId">
                <input type="hidden" id="syncSheetUrl">
                <div class="form-group">
                    <label>×§××¤×™×™×Ÿ</label>
                    <input type="text" id="syncCampaignName" readonly style="background: #f3f4f6;">
                </div>

                <!-- Preview Button -->
                <div class="form-group">
                    <button type="button" class="btn-modal" onclick="previewSheet()" style="background: #3b82f6;">
                        ğŸ‘ï¸ ×”×¦×’ ×©×•×¨×•×ª ××—×¨×•× ×•×ª
                    </button>
                </div>

                <!-- Preview Table -->
                <div id="sheetPreview" style="display: none; margin-bottom: 15px;">
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; max-height: 400px; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong style="color: #1f2937;">×©×•×¨×•×ª ××—×¨×•× ×•×ª ××”×’×™×œ×™×•×Ÿ</strong>
                            <span id="totalRowsInfo" style="color: #6b7280; font-size: 0.9em;"></span>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                            <thead style="background: #e5e7eb;">
                                <tr>
                                    <th style="padding: 8px; text-align: center; border: 1px solid #d1d5db;">×‘×—×¨</th>
                                    <th style="padding: 8px; text-align: right; border: 1px solid #d1d5db;">×©×•×¨×”</th>
                                    <th style="padding: 8px; text-align: right; border: 1px solid #d1d5db;">×©×</th>
                                    <th style="padding: 8px; text-align: right; border: 1px solid #d1d5db;">×˜×œ×¤×•×Ÿ</th>
                                    <th style="padding: 8px; text-align: right; border: 1px solid #d1d5db;">××™××™×™×œ</th>
                                    <th style="padding: 8px; text-align: right; border: 1px solid #d1d5db;">×ª××¨×™×š</th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="form-group">
                    <label>××©×•×¨×” <span style="color:red;">*</span></label>
                    <input type="number" id="syncStartRow" min="2" value="2" required>
                    <small style="color: #6b7280; display: block; margin-top: 5px;">
                        ×”×©×•×¨×” ×”×¨××©×•× ×” ×œ×¡× ×›×¨×•×Ÿ (×©×•×¨×” 1 = ×›×•×ª×¨×•×ª, 2 = × ×ª×•× ×™× ×¨××©×•× ×™×)
                    </small>
                </div>
                <div class="form-group">
                    <label>×¢×“ ×©×•×¨×” (××•×¤×¦×™×•× ×œ×™)</label>
                    <input type="number" id="syncEndRow" min="2">
                    <small style="color: #6b7280; display: block; margin-top: 5px;">
                        ×”×©××¨ ×¨×™×§ ×œ×¡× ×›×¨×•×Ÿ ×¢×“ ×”×¡×•×£
                    </small>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="syncResetTracking">
                        <span>××¤×¡ ××¢×§×‘ (×”×ª×—×œ ××—×“×©)</span>
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-modal btn-cancel" onclick="closeSyncConfigModal()">×‘×™×˜×•×œ</button>
                    <button type="submit" class="btn-modal">â–¶ï¸ ×”×ª×—×œ ×¡× ×›×¨×•×Ÿ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Sync Result Modal -->
    <div id="syncResultModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header" id="syncResultTitle">ğŸ“Š ×ª×•×¦××•×ª ×¡× ×›×¨×•×Ÿ</h2>
            <div id="syncResultContent" class="result-box"></div>
            <button class="copy-btn" onclick="copySyncResult()">ğŸ“‹ ×”×¢×ª×§ ×œ×©×œ×™×—×”</button>
            <div class="modal-actions">
                <button type="button" class="btn-modal" onclick="closeSyncResultModal()">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <script>
        let campaigns = [];
        let customers = [];

        // ========== LANGUAGE SYSTEM ==========
        const translations = {
            he: {
                // Header
                page_title: '×× ×”×œ ×§××¤×™×™×Ÿ - × ×™×”×•×œ ×œ×™×“×™×',
                campaign_manager: '(×× ×”×œ ×§××¤×™×™×Ÿ)',
                manage_campaigns: '× ×™×”×•×œ ×§××¤×™×™× ×™×',
                logout: '×™×¦×™××”',

                // Sync section
                sync_campaigns_title: '×¡× ×›×¨×•×Ÿ ×§××¤×™×™× ×™× ×-Google Sheets',
                sync_all_campaigns: '×¡× ×›×¨×Ÿ ××ª ×›×œ ×”×§××¤×™×™× ×™×',
                add_lead_manual: '×”×•×¡×£ ×œ×™×“ ×™×“× ×™×ª',
                loading_campaigns: '×˜×•×¢×Ÿ ×§××¤×™×™× ×™×...',
                no_active_campaigns: '××™×Ÿ ×§××¤×™×™× ×™× ×¤×¢×™×œ×™× ×¢× ×§×™×©×•×¨ Google Sheets',
                no_customer: '×œ×œ× ×œ×§×•×—',
                never_synced: '××¢×•×œ× ×œ× ×¡×•× ×›×¨×Ÿ',
                last_synced: '×¡×•× ×›×¨×Ÿ ×œ××—×¨×•× ×”',
                sync_btn: '×¡× ×›×¨×Ÿ',

                // Quick actions
                quick_actions: '×¤×¢×•×œ×•×ª ××”×™×¨×•×ª',
                quick_actions_desc: '×©×œ×— ×ª×–×›×•×¨×•×ª ×œ××©×ª××©×™× ×¢×œ ×œ×™×“×™× ×©×”×•×§×¦×• ×œ×”×',
                selected: '× ×‘×—×¨×•',
                send_reminder_selected: '×©×œ×— ×ª×–×›×•×¨×ª ×œ×œ×™×“×™× × ×‘×—×¨×™×',
                send_reminder_tooltip: '×‘×—×¨ ×œ×™×“×™× ×‘×˜×‘×œ×” ×œ××˜×” ×•×œ×—×¥ ×›××Ÿ ×œ×©×œ×•×— ×ª×–×›×•×¨×ª ×œ××©×ª××©×™×',

                // Email status
                email_checking: '×”×ª×¨××•×ª ××™××™×™×œ: ×‘×•×“×§ ×”×’×“×¨×•×ª...',
                email_active: '×”×ª×¨××•×ª ××™××™×™×œ ×¤×¢×™×œ×•×ª - ×©×•×œ×— ×',
                email_not_configured: '×”×ª×¨××•×ª ××™××™×™×œ ×œ× ××•×’×“×¨×•×ª - ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª',
                email_check_error: '×œ× × ×™×ª×Ÿ ×œ×‘×“×•×§ ×¡×˜×˜×•×¡ ×”×ª×¨××•×ª',

                // Add Lead Modal
                add_lead_title: '×”×•×¡×£ ×œ×™×“ ×™×“× ×™×ª',
                customer: '×œ×§×•×—',
                campaign_name: '×©× ×§××¤×™×™×Ÿ',
                full_name: '×©× ××œ×',
                phone: '×˜×œ×¤×•×Ÿ',
                email: '××™××™×™×œ',
                status: '×¡×˜×˜×•×¡',
                notes: '×”×¢×¨×•×ª',
                cancel: '×‘×™×˜×•×œ',
                add_lead: '×”×•×¡×£ ×œ×™×“',
                select_customer: '×‘×—×¨ ×œ×§×•×— ×ª×—×™×œ×”...',
                select_campaign: '×‘×—×¨ ×§××¤×™×™×Ÿ...',
                no_customers: '××™×Ÿ ×œ×§×•×—×•×ª ×–××™× ×™×',
                no_campaigns_for_customer: '××™×Ÿ ×§××¤×™×™× ×™× ×–××™× ×™× ×œ×œ×§×•×— ×–×”',
                error_loading_customers: '×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×§×•×—×•×ª',
                error_loading_campaigns: '×©×’×™××” ×‘×˜×¢×™× ×ª ×§××¤×™×™× ×™×',
                phone_or_email_required: '× ×“×¨×© ×œ×¤×—×•×ª ×˜×œ×¤×•×Ÿ ××• ××™××™×™×œ',
                lead_added_success: '×”×œ×™×“ × ×•×¡×£ ×‘×”×¦×œ×—×”! ID',

                // Status options
                status_new: '×—×“×©',
                status_contacted: '× ×•×¦×¨ ×§×©×¨',
                status_qualified: '××ª××™×',
                status_converted: '×”×•××¨',
                status_lost: '××‘×•×“',

                // Sync config modal
                sync_settings: '×”×’×“×¨×•×ª ×¡× ×›×¨×•×Ÿ',
                campaign: '×§××¤×™×™×Ÿ',
                show_last_rows: '×”×¦×’ ×©×•×¨×•×ª ××—×¨×•× ×•×ª',
                from_row: '××©×•×¨×”',
                to_row: '×¢×“ ×©×•×¨×” (××•×¤×¦×™×•× ×œ×™)',
                reset_tracking: '××¤×¡ ××¢×§×‘ (×”×ª×—×œ ××—×“×©)',
                start_sync: '×”×ª×—×œ ×¡× ×›×¨×•×Ÿ',
                first_row_help: '×”×©×•×¨×” ×”×¨××©×•× ×” ×œ×¡× ×›×¨×•×Ÿ (×©×•×¨×” 1 = ×›×•×ª×¨×•×ª, 2 = × ×ª×•× ×™× ×¨××©×•× ×™×)',
                leave_empty_for_all: '×”×©××¨ ×¨×™×§ ×œ×¡× ×›×¨×•×Ÿ ×¢×“ ×”×¡×•×£',
                last_rows_from_sheet: '×©×•×¨×•×ª ××—×¨×•× ×•×ª ××”×’×™×œ×™×•×Ÿ',
                total_rows: '×¡×”"×› ×©×•×¨×•×ª ×‘×’×™×œ×™×•×Ÿ',
                select: '×‘×—×¨',
                row: '×©×•×¨×”',
                name: '×©×',
                date: '×ª××¨×™×š',

                // Sync result
                sync_results: '×ª×•×¦××•×ª ×¡× ×›×¨×•×Ÿ',
                sync_success: '×¡× ×›×¨×•×Ÿ ×”×•×©×œ× ×‘×”×¦×œ×—×”',
                sync_error: '×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ',
                copy_to_send: '×”×¢×ª×§ ×œ×©×œ×™×—×”',
                close: '×¡×’×•×¨',
                copied: '×”×•×¢×ª×§!',

                // Alerts
                syncing: '××¡× ×›×¨×Ÿ...',
                checking_campaigns: '×‘×•×“×§ ×§××¤×™×™× ×™×...',
                error: '×©×’×™××”',
                campaign_not_found: '×§××¤×™×™×Ÿ ×œ× × ××¦×',
                missing_campaign_id: '××–×”×” ×§××¤×™×™×Ÿ ×—×¡×¨',
                no_sheet_link: '××™×Ÿ ×§×™×©×•×¨ ×œ×’×™×œ×™×•×Ÿ',
                preview_error: '×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×ª×¦×•×’×” ××§×“×™××”',
                preview_load_error: '×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×¦×•×’×” ××§×“×™××”'
            },
            en: {
                // Header
                page_title: 'Campaign Manager - Lead Management',
                campaign_manager: '(Campaign Manager)',
                manage_campaigns: 'Manage Campaigns',
                logout: 'Logout',

                // Sync section
                sync_campaigns_title: 'Sync Campaigns from Google Sheets',
                sync_all_campaigns: 'Sync All Campaigns',
                add_lead_manual: 'Add Lead Manually',
                loading_campaigns: 'Loading campaigns...',
                no_active_campaigns: 'No active campaigns with Google Sheets link',
                no_customer: 'No customer',
                never_synced: 'Never synced',
                last_synced: 'Last synced',
                sync_btn: 'Sync',

                // Quick actions
                quick_actions: 'Quick Actions',
                quick_actions_desc: 'Send reminders to users about leads assigned to them',
                selected: 'selected',
                send_reminder_selected: 'Send Reminder to Selected Leads',
                send_reminder_tooltip: 'Select leads in the table below and click here to send reminders',

                // Email status
                email_checking: 'Email notifications: Checking settings...',
                email_active: 'Email notifications active - Sending from',
                email_not_configured: 'Email notifications not configured - Contact admin',
                email_check_error: 'Cannot check notification status',

                // Add Lead Modal
                add_lead_title: 'Add Lead Manually',
                customer: 'Customer',
                campaign_name: 'Campaign Name',
                full_name: 'Full Name',
                phone: 'Phone',
                email: 'Email',
                status: 'Status',
                notes: 'Notes',
                cancel: 'Cancel',
                add_lead: 'Add Lead',
                select_customer: 'Select customer first...',
                select_campaign: 'Select campaign...',
                no_customers: 'No customers available',
                no_campaigns_for_customer: 'No campaigns available for this customer',
                error_loading_customers: 'Error loading customers',
                error_loading_campaigns: 'Error loading campaigns',
                phone_or_email_required: 'Phone or email is required',
                lead_added_success: 'Lead added successfully! ID',

                // Status options
                status_new: 'New',
                status_contacted: 'Contacted',
                status_qualified: 'Qualified',
                status_converted: 'Converted',
                status_lost: 'Lost',

                // Sync config modal
                sync_settings: 'Sync Settings',
                campaign: 'Campaign',
                show_last_rows: 'Show Last Rows',
                from_row: 'From Row',
                to_row: 'To Row (optional)',
                reset_tracking: 'Reset tracking (start fresh)',
                start_sync: 'Start Sync',
                first_row_help: 'First row to sync (row 1 = headers, 2 = first data)',
                leave_empty_for_all: 'Leave empty to sync all',
                last_rows_from_sheet: 'Last rows from sheet',
                total_rows: 'Total rows in sheet',
                select: 'Select',
                row: 'Row',
                name: 'Name',
                date: 'Date',

                // Sync result
                sync_results: 'Sync Results',
                sync_success: 'Sync completed successfully',
                sync_error: 'Sync error',
                copy_to_send: 'Copy to send',
                close: 'Close',
                copied: 'Copied!',

                // Alerts
                syncing: 'Syncing...',
                checking_campaigns: 'Checking campaigns...',
                error: 'Error',
                campaign_not_found: 'Campaign not found',
                missing_campaign_id: 'Missing campaign ID',
                no_sheet_link: 'No sheet link',
                preview_error: 'Cannot load preview',
                preview_load_error: 'Error loading preview'
            }
        };

        let currentLang = localStorage.getItem('appLanguage') || 'he';

        function t(key) {
            return translations[currentLang][key] || translations['he'][key] || key;
        }

        function toggleLanguage() {
            currentLang = currentLang === 'he' ? 'en' : 'he';
            localStorage.setItem('appLanguage', currentLang);
            applyLanguage();
        }

        function applyLanguage() {
            const html = document.documentElement;
            const btn = document.getElementById('langToggleBtn');

            // Update direction and lang
            if (currentLang === 'en') {
                html.setAttribute('dir', 'ltr');
                html.setAttribute('lang', 'en');
                btn.textContent = 'HE';
            } else {
                html.setAttribute('dir', 'rtl');
                html.setAttribute('lang', 'he');
                btn.textContent = 'EN';
            }

            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang][key]) {
                    el.textContent = translations[currentLang][key];
                }
            });

            // Update title attributes
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (translations[currentLang][key]) {
                    el.setAttribute('title', translations[currentLang][key]);
                }
            });

            // Update placeholder attributes
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[currentLang][key]) {
                    el.setAttribute('placeholder', translations[currentLang][key]);
                }
            });

            // Update email status
            updateEmailStatusText();

            // Re-render campaigns grid with new language
            if (campaigns.length > 0) {
                renderCampaignsGrid();
            }
        }

        function updateEmailStatusText() {
            const statusDiv = document.getElementById('email-status');
            if (!statusDiv) return;

            // Re-fetch email status with new language
            fetch('/email-status')
                .then(response => response.json())
                .then(data => {
                    if (data.enabled) {
                        statusDiv.className = 'email-status enabled';
                        statusDiv.innerHTML = `ğŸ“§ ${t('email_active')}: ${data.sender_email}`;
                    } else {
                        statusDiv.innerHTML = `ğŸ“§ ${t('email_not_configured')}`;
                    }
                })
                .catch(error => {
                    statusDiv.innerHTML = `ğŸ“§ ${t('email_check_error')}`;
                });
        }

        function renderCampaignsGrid() {
            const syncableCampaigns = campaigns.filter(c => c.active && c.sheet_url);
            const grid = document.getElementById('campaignsGrid');

            if (syncableCampaigns.length === 0) {
                grid.innerHTML = `<p style="text-align: center; color: #64748b;">${t('no_active_campaigns')}</p>`;
            } else {
                grid.innerHTML = syncableCampaigns.map(c => {
                    let lastSyncText = t('never_synced');
                    if (c.last_synced_at) {
                        const syncDate = new Date(c.last_synced_at);
                        const formattedTime = syncDate.toLocaleString(currentLang === 'he' ? 'he-IL' : 'en-US', {
                            timeZone: 'Asia/Jerusalem',
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        lastSyncText = `${t('last_synced')}: ${formattedTime}`;
                    }

                    return `
                    <div class="campaign-card">
                        <div class="campaign-info">
                            <h3>${c.campaign_name}</h3>
                            <p>${c.customer_name || t('no_customer')}</p>
                            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">${lastSyncText}</p>
                        </div>
                        <button class="btn-sync" onclick="syncCampaign(${c.id}, '${c.campaign_name.replace(/'/g, "\\'")}')">ğŸ”„ ${t('sync_btn')}</button>
                    </div>
                    `;
                }).join('');
            }
        }

        // Apply language on page load
        document.addEventListener('DOMContentLoaded', function() {
            applyLanguage();
        });
        
        // Load customers for the add lead form
        async function loadCustomers() {
            try {
                const r = await fetch('/admin/customers/api');
                const data = await r.json();
                customers = data || [];

                if (customers.length === 0) {
                    document.getElementById('addLeadCustomerId').innerHTML = '<option value="">××™×Ÿ ×œ×§×•×—×•×ª ×–××™× ×™×</option>';
                    return;
                }

                // Build options with customer ID 1 as default (selected)
                const customerOptions = customers.map(c =>
                    `<option value="${c.id}" ${c.id === 1 ? 'selected' : ''}>${c.name}</option>`
                ).join('');

                document.getElementById('addLeadCustomerId').innerHTML = customerOptions;
            } catch(e) {
                console.error('Error loading customers:', e);
                document.getElementById('addLeadCustomerId').innerHTML = '<option value="">×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×§×•×—×•×ª</option>';
            }
        }

        // Load campaigns for the add lead form
        async function loadCampaignsForLead() {
            try {
                const selectedCustomerId = document.getElementById('addLeadCustomerId').value;
                if (!selectedCustomerId) {
                    document.getElementById('addLeadCampaignName').innerHTML = '<option value="">×‘×—×¨ ×œ×§×•×— ×ª×—×™×œ×”...</option>';
                    return;
                }

                const r = await fetch('/admin/campaigns/api');
                const data = await r.json();
                const allCampaigns = data.campaigns || [];

                // Filter campaigns by selected customer
                const customerCampaigns = allCampaigns.filter(c =>
                    c.customer_id == selectedCustomerId && c.active
                );

                if (customerCampaigns.length === 0) {
                    document.getElementById('addLeadCampaignName').innerHTML = '<option value="">××™×Ÿ ×§××¤×™×™× ×™× ×–××™× ×™× ×œ×œ×§×•×— ×–×”</option>';
                    return;
                }

                // Build campaign options
                const campaignOptions = '<option value="">×‘×—×¨ ×§××¤×™×™×Ÿ...</option>' +
                    customerCampaigns.map(c =>
                        `<option value="${c.campaign_name}">${c.campaign_name}</option>`
                    ).join('');

                document.getElementById('addLeadCampaignName').innerHTML = campaignOptions;
            } catch(e) {
                console.error('Error loading campaigns:', e);
                document.getElementById('addLeadCampaignName').innerHTML = '<option value="">×©×’×™××” ×‘×˜×¢×™× ×ª ×§××¤×™×™× ×™×</option>';
            }
        }

        async function openAddLeadModal() {
            document.getElementById('addLeadForm').reset();
            await loadCustomers();
            await loadCampaignsForLead();
            document.getElementById('addLeadModal').style.display = 'block';
        }

        // Initialize all event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Reload campaigns when customer changes
            const customerSelect = document.getElementById('addLeadCustomerId');
            if (customerSelect) {
                customerSelect.addEventListener('change', loadCampaignsForLead);
            }

            // Handle sync config form submission
            const syncConfigForm = document.getElementById('syncConfigForm');
            if (syncConfigForm) {
                syncConfigForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const startRow = parseInt(document.getElementById('syncStartRow').value);
                    const endRow = document.getElementById('syncEndRow').value;
                    const resetTracking = document.getElementById('syncResetTracking').checked;

                    // Save campaign ID before closing modal (which clears it)
                    const campaignId = currentSyncCampaignId;
                    const syncButton = currentSyncButton;

                    closeSyncConfigModal();

                    if (!campaignId) {
                        alert('×©×’×™××”: ××–×”×” ×§××¤×™×™×Ÿ ×—×¡×¨');
                        console.error('campaignId is:', campaignId);
                        return;
                    }

                    console.log('Syncing campaign ID:', campaignId);

                    if (syncButton) {
                        syncButton.disabled = true;
                        syncButton.textContent = 'â³ ××¡× ×›×¨×Ÿ...';
                    }

                    try {
                        const response = await fetch(`/admin/campaigns/sync/${campaignId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                start_row: startRow,
                                reset_tracking: resetTracking
                            })
                        });

                        // Check content type before parsing
                        const contentType = response.headers.get('content-type');
                        console.log('Response status:', response.status);
                        console.log('Content-Type:', contentType);

                        if (!contentType || !contentType.includes('application/json')) {
                            const text = await response.text();
                            console.error('Non-JSON response:', text.substring(0, 500));
                            throw new Error(`Server returned ${contentType || 'unknown type'} instead of JSON. Status: ${response.status}`);
                        }

                        const result = await response.json();

                        if (response.ok) {
                            showSyncResult(result, true);
                        } else {
                            showSyncResult(result, false);
                        }
                    } catch(e) {
                        console.error('Sync error:', e);
                        showSyncResult({ error: e.message }, false);
                    } finally {
                        if (syncButton) {
                            syncButton.disabled = false;
                            syncButton.textContent = 'ğŸ”„ ×¡× ×›×¨×Ÿ';
                        }
                    }
                });
            }
        });
        
        function closeAddLeadModal() {
            document.getElementById('addLeadModal').style.display = 'none';
        }
        
        document.getElementById('addLeadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const phone = document.getElementById('addLeadPhone').value.trim();
            const email = document.getElementById('addLeadEmail').value.trim();
            
            if (!phone && !email) {
                alert('× ×“×¨×© ×œ×¤×—×•×ª ×˜×œ×¤×•×Ÿ ××• ××™××™×™×œ');
                return;
            }
            
            const data = {
                customer_id: parseInt(document.getElementById('addLeadCustomerId').value),
                campaign_name: document.getElementById('addLeadCampaignName').value,
                name: document.getElementById('addLeadName').value,
                phone: phone || null,
                email: email || null,
                status: document.getElementById('addLeadStatus').value,
                notes: document.getElementById('addLeadNotes').value
            };
            
            try {
                const response = await fetch('/admin/leads/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('âœ… ×”×œ×™×“ × ×•×¡×£ ×‘×”×¦×œ×—×”! ID: ' + result.lead_id);
                    closeAddLeadModal();
                    // Reload the leads table if it exists
                    if (typeof refreshLeadsTable === 'function') {
                        refreshLeadsTable();
                    }
                } else {
                    alert('âŒ ×©×’×™××”: ' + (result.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'));
                }
            } catch(e) {
                alert('âŒ ×©×’×™××”: ' + e.message);
            }
        });
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const addLeadModal = document.getElementById('addLeadModal');
            const syncResultModal = document.getElementById('syncResultModal');
            const syncConfigModal = document.getElementById('syncConfigModal');
            if (event.target === addLeadModal) {
                closeAddLeadModal();
            }
            if (event.target === syncResultModal) {
                closeSyncResultModal();
            }
            if (event.target === syncConfigModal) {
                closeSyncConfigModal();
            }
        }
        
        // Load campaigns
        async function loadCampaigns() {
            try {
                const response = await fetch('/admin/campaigns/api');
                const data = await response.json();
                campaigns = data.campaigns || [];
                renderCampaignsGrid();
            } catch(e) {
                console.error('Error loading campaigns:', e);
                document.getElementById('campaignsGrid').innerHTML = `<p style="text-align: center; color: #ef4444;">${t('error_loading_campaigns')}</p>`;
            }
        }
        
        // Store current sync context
        let currentSyncCampaignId = null;
        let currentSyncButton = null;

        // Open sync configuration modal
        function syncCampaign(campaignId, campaignName) {
            const campaign = campaigns.find(c => c.id === campaignId);
            if (!campaign) {
                alert('×§××¤×™×™×Ÿ ×œ× × ××¦×');
                return;
            }

            currentSyncCampaignId = campaignId;
            currentSyncButton = event.target;

            // Pre-fill modal
            document.getElementById('syncCampaignId').value = campaign.id;
            document.getElementById('syncCampaignName').value = campaign.campaign_name;
            document.getElementById('syncSheetUrl').value = campaign.sheet_url || '';

            // Get the last row number from database and suggest next row
            fetch(`/admin/campaigns/${campaign.id}/last-row-number`)
                .then(response => response.json())
                .then(data => {
                    const suggestedStartRow = data.last_row_number ? data.last_row_number + 1 : 2;
                    document.getElementById('syncStartRow').value = suggestedStartRow;

                    // Show a helpful message if we have a last row
                    if (data.last_row_number) {
                        const startRowInput = document.getElementById('syncStartRow');
                        const helpText = startRowInput.nextElementSibling;
                        if (helpText && helpText.tagName === 'SMALL') {
                            helpText.innerHTML = `×”×©×•×¨×” ×”×¨××©×•× ×” ×œ×¡× ×›×¨×•×Ÿ (×©×•×¨×” ××—×¨×•× ×” ×‘DB: ${data.last_row_number}, ××¦×™×¢: ${suggestedStartRow})`;
                            helpText.style.color = '#059669';
                            helpText.style.fontWeight = '600';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching last row number:', error);
                    document.getElementById('syncStartRow').value = 2;
                });

            document.getElementById('syncEndRow').value = '';
            document.getElementById('syncResetTracking').checked = false;

            // Hide preview initially
            document.getElementById('sheetPreview').style.display = 'none';

            document.getElementById('syncConfigModal').style.display = 'block';
        }

        async function previewSheet() {
            const sheetUrl = document.getElementById('syncSheetUrl').value;
            if (!sheetUrl) {
                alert('××™×Ÿ ×§×™×©×•×¨ ×œ×’×™×œ×™×•×Ÿ');
                return;
            }

            try {
                const response = await fetch('/admin/campaigns/preview-sheet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sheet_url: sheetUrl })
                });

                const result = await response.json();

                if (!response.ok) {
                    alert('×©×’×™××”: ' + (result.error || '×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×ª×¦×•×’×” ××§×“×™××”'));
                    return;
                }

                // Display preview
                document.getElementById('totalRowsInfo').textContent = `×¡×”"×› ${result.total_rows} ×©×•×¨×•×ª ×‘×’×™×œ×™×•×Ÿ`;

                const tbody = document.getElementById('previewTableBody');
                tbody.innerHTML = result.preview_rows.map(row => `
                    <tr style="background: ${row.has_data ? 'white' : '#fef3c7'};">
                        <td style="padding: 6px; text-align: center; border: 1px solid #d1d5db;">
                            <input type="radio" name="previewRow" value="${row.row_number}"
                                   onclick="document.getElementById('syncStartRow').value = ${row.row_number}">
                        </td>
                        <td style="padding: 6px; border: 1px solid #d1d5db; font-weight: bold;">${row.row_number}</td>
                        <td style="padding: 6px; border: 1px solid #d1d5db;">${row.name || '-'}</td>
                        <td style="padding: 6px; border: 1px solid #d1d5db; direction: ltr; text-align: left;">${row.phone || '-'}</td>
                        <td style="padding: 6px; border: 1px solid #d1d5db;">${row.email || '-'}</td>
                        <td style="padding: 6px; border: 1px solid #d1d5db;">${row.date || '-'}</td>
                    </tr>
                `).join('');

                document.getElementById('sheetPreview').style.display = 'block';

            } catch (e) {
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×¦×•×’×” ××§×“×™××”: ' + e.message);
            }
        }

        function closeSyncConfigModal() {
            document.getElementById('syncConfigModal').style.display = 'none';
            document.getElementById('sheetPreview').style.display = 'none';
            currentSyncCampaignId = null;
            currentSyncButton = null;
        }

        // Removed: syncAllCampaigns() and migrateRowNumbers() functions - no longer needed
        
        function showSyncResult(result, isSuccess, customTitle = null) {
            const modal = document.getElementById('syncResultModal');
            const title = document.getElementById('syncResultTitle');
            const content = document.getElementById('syncResultContent');
            
            if (isSuccess) {
                title.textContent = customTitle || 'âœ… ×¡× ×›×¨×•×Ÿ ×”×•×©×œ× ×‘×”×¦×œ×—×”';
                content.className = 'result-box result-success';
                
                if (result.text) {
                    content.textContent = result.text;
                } else {
                    content.textContent = 
                        `×§××¤×™×™×Ÿ: ${result.campaign_name}\n` +
                        `Tab GID: ${result.tab_gid}\n` +
                        `×©×•×¨×•×ª ×©× ×‘×“×§×•: ${result.total_rows_checked}\n` +
                        `×œ×™×“×™× ×—×“×©×™×: ${result.new_leads}\n` +
                        `×›×¤×™×œ×•×™×•×ª ×©×“×•×œ×’×•: ${result.duplicates}\n` +
                        `×©×’×™××•×ª: ${result.errors}\n` +
                        `×©×•×¨×” ××—×¨×•× ×” ×©×¡×•× ×›×¨× ×”: ${result.last_synced_row}\n\n` +
                        `××¢×§×‘ ××œ×:\n${JSON.stringify(result.last_synced_data, null, 2)}`;
                }
            } else {
                title.textContent = 'âŒ ×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ';
                content.className = 'result-box result-error';
                content.textContent = result.error || '×©×’×™××” ×œ× ×™×“×•×¢×”';
            }
            
            modal.style.display = 'block';
        }
        
        function closeSyncResultModal() {
            document.getElementById('syncResultModal').style.display = 'none';
        }
        
        function copySyncResult() {
            const content = document.getElementById('syncResultContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ“ ×”×•×¢×ª×§!';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#3b82f6';
                }, 2000);
            }).catch(err => {
                alert('×©×’×™××” ×‘×”×¢×ª×§×”: ' + err.message);
            });
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const syncResultModal = document.getElementById('syncResultModal');
            if (event.target === syncResultModal) {
                closeSyncResultModal();
            }
        }
        
        // Load campaigns on page load
        loadCampaigns();
        
        // Check email notification status
        fetch('/email-status')
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('email-status');
                if (data.enabled) {
                    statusDiv.className = 'email-status enabled';
                    statusDiv.innerHTML = `ğŸ“§ ×”×ª×¨××•×ª ××™××™×™×œ ×¤×¢×™×œ×•×ª - ×©×•×œ×— ×: ${data.sender_email}`;
                } else {
                    statusDiv.innerHTML = 'ğŸ“§ ×”×ª×¨××•×ª ××™××™×™×œ ×œ× ××•×’×“×¨×•×ª - ×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª';
                }
            })
            .catch(error => {
                document.getElementById('email-status').innerHTML = 'ğŸ“§ ×œ× × ×™×ª×Ÿ ×œ×‘×“×•×§ ×¡×˜×˜×•×¡ ×”×ª×¨××•×ª';
            });

        // Sync All Campaigns Function
        async function syncAllCampaigns() {
            const btn = event.target;
            const originalText = btn.textContent;

            try {
                // Step 1: Get preview
                btn.disabled = true;
                btn.textContent = 'â³ ×‘×•×“×§ ×§××¤×™×™× ×™×...';

                const previewResponse = await fetch('/admin/campaigns/sync-all-preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const previewResult = await previewResponse.json();

                if (!previewResponse.ok || !previewResult.success) {
                    alert('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×¦×•×’×” ××§×“×™××”: ' + (previewResult.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'));
                    return;
                }

                // Step 2: Show preview and get confirmation
                let previewMessage = `ğŸ“Š ×ª×¦×•×’×” ××§×“×™××” - ×¡× ×›×¨×•×Ÿ ×›×œ ×”×§××¤×™×™× ×™×\n\n`;
                previewMessage += `×¡×”"×› ×§××¤×™×™× ×™× ×¤×¢×™×œ×™×: ${previewResult.total_campaigns}\n`;
                previewMessage += `×¡×”"×› ×œ×™×“×™× ×—×“×©×™× ×œ×™×™×‘×•×: ${previewResult.total_new_leads}\n\n`;
                previewMessage += `×¤×™×¨×•×˜ ×œ×¤×™ ×§××¤×™×™×Ÿ:\n`;
                previewMessage += `${'='.repeat(50)}\n`;

                previewResult.previews.forEach(p => {
                    if (p.error) {
                        previewMessage += `\nâŒ ${p.campaign_name}: ${p.error}\n`;
                    } else {
                        previewMessage += `\nâœ… ${p.campaign_name}:\n`;
                        previewMessage += `   â€¢ ×œ×™×“×™× ×—×“×©×™×: ${p.new_leads_count}\n`;
                        previewMessage += `   â€¢ ×©×•×¨×” ××—×¨×•× ×” ×‘DB: ${p.last_synced_row}\n`;
                    }
                });

                previewMessage += `\n\n×”×× ×œ×”××©×™×š ×‘×¡× ×›×¨×•×Ÿ?`;

                if (!confirm(previewMessage)) {
                    return;
                }

                // Step 3: Execute sync
                btn.textContent = 'â³ ××¡× ×›×¨×Ÿ...';

                const response = await fetch('/admin/campaigns/sync-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Show single concise success message
                    let message = `âœ… ×¡× ×›×¨×•×Ÿ ×”×•×©×œ×!\n\n`;
                    message += `ğŸ“Š ×§××¤×™×™× ×™×: ${result.total_campaigns} | `;
                    message += `ğŸ†• ×œ×™×“×™× ×—×“×©×™×: ${result.total_new_leads} | `;
                    message += `ğŸ”„ ×›×¤×™×œ×•×™×•×ª: ${result.total_duplicates}`;

                    if (result.total_errors > 0) {
                        message += `\nâš ï¸ ×©×’×™××•×ª: ${result.total_errors}`;
                    }

                    alert(message);

                    // Reload campaigns grid AND leads list
                    loadCampaigns();

                    // Refresh the unified lead manager if it exists
                    if (window.UnifiedLeadManager) {
                        window.UnifiedLeadManager.loadLeads();
                    }
                } else {
                    alert('âŒ ×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ: ' + (result.error || '×©×’×™××” ×œ× ×™×“×•×¢×”'));
                }
            } catch(e) {
                alert('âŒ ×©×’×™××”: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
    </script>
    
    <!-- Version Footer -->
    <div style="position: fixed; bottom: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 8px 15px; border-radius: 8px; font-size: 11px; color: #64748b; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-family: 'Courier New', monospace;">
        ğŸš€ {{ version }} | ğŸ•’ {{ build_time }}
    </div>
</body>
</html>