<!-- Unified Lead Management Component - Works for all roles -->
<!-- Admin, Campaign Manager, and Employee - Same powerful interface -->

<style>
    /* Modern Lead Manager Styles */
    .lead-manager-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        margin: 20px 0;
    }
    
    /* Header Section */
    .lead-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .lead-title {
        font-size: 1.8em;
        font-weight: bold;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .lead-stats {
        display: flex;
        gap: 20px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        padding: 10px 20px;
        border-radius: 10px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #059669;
    }
    
    .stat-label {
        font-size: 0.9em;
        color: #6b7280;
    }
    
    /* Control Panel */
    .control-panel {
        background: #f8fafc;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .filter-label {
        font-size: 0.85em;
        color: #6b7280;
        font-weight: 600;
    }
    
    .filter-select, .filter-input {
        padding: 10px 15px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        background: white;
        font-size: 14px;
        min-width: 150px;
        transition: all 0.2s;
    }
    
    .filter-select:focus, .filter-input:focus {
        border-color: #059669;
        outline: none;
        box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }
    
    /* Customer Selector for Admin */
    .customer-selector {
        background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .customer-selector select {
        background: white;
        color: #1e293b;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        font-weight: 600;
    }
    
    /* Action Buttons */
    .action-btn {
        padding: 10px 16px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        text-decoration: none;
    }
    
    .btn-primary {
        background: #3b82f6;
        color: white;
    }
    
    .btn-primary:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn-call {
        background: #10b981;
        color: white;
    }
    
    .btn-call:hover {
        background: #059669;
        transform: translateY(-1px);
    }
    
    .btn-whatsapp {
        background: #25d366;
        color: white;
    }
    
    .btn-whatsapp:hover {
        background: #128c7e;
        transform: translateY(-1px);
    }
    
    .btn-email {
        background: #8b5cf6;
        color: white;
    }
    
    .btn-email:hover {
        background: #7c3aed;
        transform: translateY(-1px);
    }
    
    .btn-assign {
        background: #f59e0b;
        color: white;
    }
    
    .btn-assign:hover {
        background: #d97706;
        transform: translateY(-1px);
    }
    
    /* Lead Cards for Mobile */
    .lead-cards-container {
        display: none; /* Hidden by default, shown on mobile */
    }
    
    .lead-card {
        background: white;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e2e8f0;
    }
    
    .lead-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }
    
    .lead-card-name {
        font-size: 16px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 4px;
    }
    
    .lead-card-phone {
        font-size: 14px;
        color: #6b7280;
        direction: ltr;
        text-align: right;
    }
    
    .lead-card-status {
        flex-shrink: 0;
    }
    
    .lead-card-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 12px;
        font-size: 13px;
        color: #6b7280;
    }
    
    .lead-card-actions {
        display: flex;
        gap: 8px;
        justify-content: center;
    }
    
    .lead-card-actions .action-btn {
        flex: 1;
        max-width: 60px;
        padding: 10px;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Lead Table for Desktop */
    .lead-table-container {
        display: block; /* Shown by default, hidden on mobile */
    }
    
    .lead-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .lead-table thead {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        color: white;
    }
    
    .lead-table th {
        padding: 15px;
        text-align: right;
        font-weight: 600;
        font-size: 14px;
        white-space: nowrap;
    }
    
    .lead-table tbody tr {
        border-bottom: 1px solid #f1f5f9;
        transition: all 0.2s;
    }
    
    .lead-table tbody tr:hover {
        background: #f8fafc;
        transform: scale(1.01);
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .lead-table td {
        padding: 12px 15px;
        font-size: 14px;
    }
    
    /* Status Badges */
    .status-badge {
        padding: 8px 16px;
        border-radius: 25px;
        font-size: 13px;
        font-weight: 700;
        display: inline-block;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
        user-select: none;
        position: relative;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        border-color: rgba(255,255,255,0.4);
        filter: brightness(1.1);
        z-index: 10;
    }
    
    .status-badge:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .status-badge::after {
        content: "×©×××œ: ×”×‘× | ×™××™×Ÿ: ×¡×’×•×¨";
        position: absolute;
        bottom: -25px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        pointer-events: none;
        z-index: 1000;
        font-weight: normal;
        text-transform: none;
        letter-spacing: normal;
    }
    
    .status-badge:hover::after {
        opacity: 1;
        visibility: visible;
        bottom: -30px;
    }
    
    .status-new { background: #dbeafe; color: #1e40af; }
    .status-contacted { background: #fed7aa; color: #92400e; }
    .status-qualified { background: #d1fae5; color: #065f46; }
    .status-interested { background: #e9d5ff; color: #6b21a8; }
    .status-hired { background: #a7f3d0; color: #047857; }
    .status-rejected { background: #fecaca; color: #991b1b; }
    .status-closed { background: #e5e7eb; color: #374151; }
    
    /* Priority Indicators */
    .priority-high {
        color: #dc2626;
        font-weight: bold;
    }
    
    .priority-medium {
        color: #f59e0b;
        font-weight: 600;
    }
    
    .priority-low {
        color: #6b7280;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px;
        color: #6b7280;
    }
    
    .empty-state-icon {
        font-size: 4em;
        margin-bottom: 20px;
        opacity: 0.3;
    }
    
    /* Loading State */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e2e8f0;
        border-top-color: #059669;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Mobile-first: Leads at top, filters at bottom */
    .lead-manager-container {
        display: flex;
        flex-direction: column;
    }
    
    .leads-display {
        order: 1; /* Leads always first */
    }
    
    .control-panel {
        order: 2; /* Filters always second */
    }
    
    /* Mobile Design */
    @media (max-width: 768px) {
        .lead-cards-container {
            display: block; /* Show cards on mobile */
        }
        
        .lead-table-container {
            display: none; /* Hide table on mobile */
        }
        
        .control-panel {
            flex-direction: column;
            align-items: stretch;
            margin-top: 20px;
            margin-bottom: 0;
        }
        
        .action-btn {
            padding: 10px 12px;
            font-size: 14px;
            min-height: 44px; /* Touch-friendly */
        }
        
        .lead-header {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }
        
        .lead-title {
            justify-content: center;
        }
    }
    
    /* Desktop Design */
    @media (min-width: 769px) {
        .lead-cards-container {
            display: none; /* Hide cards on desktop */
        }
        
        .lead-table-container {
            display: block; /* Show table on desktop */
        }
    }
</style>

<div class="lead-manager-container">
    <!-- Leads Display (Cards + Table) -->
    <div class="leads-display" style="position: relative;">
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
        </div>
        
        <!-- Mobile Cards -->
        <div class="lead-cards-container" id="leadCardsContainer">
            <!-- Lead cards will be populated here -->
        </div>
        
        <!-- Desktop Table -->
        <div class="lead-table-container" style="overflow-x: auto;">
            <table class="lead-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="selectAll" onchange="UnifiedLeadManager.toggleSelectAll(this.checked)"
                                   title="×‘×—×¨/×‘×˜×œ ×‘×—×™×¨×” ×©×œ ×›×œ ×”×œ×™×“×™× ×”××•×¦×’×™×">
                        </th>
                        <th>×¤×¢×•×œ×•×ª</th>
                        <th>×¡×˜×˜×•×¡</th>
                        <th>×©×</th>
                        <th>×§××¤×™×™×Ÿ</th>
                        <th>××•×§×¦×” ×œ</th>
                        <th>×ª××¨×™×š</th>
                    </tr>
                </thead>
                <tbody id="leadsTableBody">
                    <!-- Leads will be populated here -->
                </tbody>
            </table>
        </div>
        
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">ğŸ“­</div>
            <h3>××™×Ÿ ×œ×™×“×™× ×œ×”×¦×’×”</h3>
            <p>× ×¡×” ×œ×©× ×•×ª ××ª ×”×¤×™×œ×˜×¨×™× ××• ×œ×¨×¢× ×Ÿ ××ª ×”×¨×©×™××”</p>
        </div>
    </div>
    
    <!-- Control Panel (Filters) -->
    <div class="control-panel">
        <!-- Customer Selector (Admin Only) -->
        <div id="customerSelectorDiv" class="customer-selector" style="display: none;" 
             title="×‘×—×¨ ×œ×§×•×— ×œ×¦×¤×™×™×” ×‘×œ×™×“×™× ×©×œ×• ×‘×œ×‘×“">
            <span>ğŸ¢ ×œ×§×•×—:</span>
            <select id="customerSelector" onchange="UnifiedLeadManager.changeCustomer(this.value)"
                    title="×”×—×œ×£ ×‘×™×Ÿ ×œ×§×•×—×•×ª ×©×•× ×™× ×œ× ×™×”×•×œ ×”×œ×™×“×™× ×©×œ×”×">
                <option value="">×‘×—×¨ ×œ×§×•×—</option>
            </select>
        </div>
        
        <!-- Filters -->
        <div class="filter-group">
            <label class="filter-label">ğŸ” ×—×™×¤×•×©</label>
            <input type="text" id="searchFilter" class="filter-input" 
                   placeholder="×—×¤×© ×©×, ×˜×œ×¤×•×Ÿ, ××™××™×™×œ..." 
                   onkeyup="UnifiedLeadManager.applyFilters()"
                   title="×—×¤×© ×œ×™×“×™× ×œ×¤×™ ×©×, ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ××• ×›×ª×•×‘×ª ××™××™×™×œ">
        </div>
        
        <div class="filter-group">
            <label class="filter-label">ğŸ“Œ ×¡×˜×˜×•×¡</label>
            <select id="statusFilter" class="filter-select" onchange="UnifiedLeadManager.refreshAndApplyFilters()"
                    title="×¡× ×Ÿ ×œ×™×“×™× ×œ×¤×™ ×¡×˜×˜×•×¡ ×”×˜×™×¤×•×œ ×”× ×•×›×—×™">
                <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                <option value="not_closed" selected>×œ× ×¡×’×•×¨</option>
                <option value="new">×—×“×©</option>
                <option value="contacted">× ×•×¦×¨ ×§×©×¨</option>
                <option value="qualified">××•×›×©×¨</option>
                <option value="interested">××ª×¢× ×™×™×Ÿ</option>
                <option value="hired">×”×ª×§×‘×œ</option>
                <option value="rejected">× ×“×—×”</option>
                <option value="closed">×¡×’×•×¨</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">ğŸ‘¤ ×”×§×¦××”</label>
            <select id="assignmentFilter" class="filter-select" onchange="UnifiedLeadManager.refreshAndApplyFilters()"
                    title="×¡× ×Ÿ ×œ×™×“×™× ×œ×¤×™ ××¦×‘ ×”×”×§×¦××” ×œ××©×ª××©×™×">
                <option value="">×›×œ ×”×”×§×¦××•×ª</option>
                <option value="unassigned">×œ× ××•×§×¦×”</option>
                <option value="assigned">××•×§×¦×”</option>
                <option value="mine">×©×œ×™</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">ğŸ“… ×ª×§×•×¤×”</label>
            <select id="dateFilter" class="filter-select" onchange="UnifiedLeadManager.refreshAndApplyFilters()"
                    title="×¡× ×Ÿ ×œ×™×“×™× ×œ×¤×™ ×ª×§×•×¤×ª ×”×’×¢×ª× ×œ××¢×¨×›×ª">
                <option value="">×›×œ ×”×–××Ÿ</option>
                <option value="today">×”×™×•×</option>
                <option value="week">×”×©×‘×•×¢</option>
                <option value="month">×”×—×•×“×©</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">ğŸ¯ ×§××¤×™×™×Ÿ</label>
            <select id="campaignFilter" class="filter-select" onchange="UnifiedLeadManager.refreshAndApplyFilters()"
                    title="×¡× ×Ÿ ×œ×™×“×™× ×œ×¤×™ ×”×§××¤×™×™×Ÿ ×©××”× ×”× ×”×’×™×¢×•">
                <option value="">×›×œ ×”×§××¤×™×™× ×™×</option>
            </select>
        </div>
        
        <!-- Action Buttons -->
        <button class="action-btn btn-primary" onclick="window.UnifiedLeadManager.exportLeads()" 
                title="×™×™×¦× ××ª ×”×œ×™×“×™× ×”××¤×•×œ×˜×¨×™× ×œ×§×•×‘×¥ ××§×¡×œ">
            ğŸ“¥ ×™×™×¦× ×œ××§×¡×œ
        </button>
    </div>
    
    <!-- Header moved to bottom to save mobile space -->
    <div class="lead-header" style="margin-top: 25px; margin-bottom: 0; border-bottom: none; border-top: 2px solid #e2e8f0; padding-top: 20px; padding-bottom: 15px;">
        <div class="lead-title">
            <span>ğŸ“Š</span>
            <span>×œ×•×— ×‘×§×¨×” - × ×™×”×•×œ ×œ×™×“×™×</span>
            <span id="customerName" style="font-size: 0.7em; color: #6b7280;"></span>
        </div>
    </div>
</div>

<!-- Lead Details Modal -->
<div id="leadModal" class="modal" style="display: none;">
    <div class="modal-content" style="width: 95%; max-width: 1000px; height: 95vh;">
        <div class="modal-header">
            <h2 id="leadModalTitle">×¤×¨×˜×™ ×œ×™×“</h2>
            <span class="close" onclick="window.UnifiedLeadManager.closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="leadModalBody">
            <!-- Lead details will be populated here -->
        </div>
    </div>
</div>

<script>
// Unified Lead Manager - State of the Art Component
class UnifiedLeadManagerClass {
    constructor() {
        this.leads = [];
        this.filteredLeads = [];
        this.selectedLeads = new Set();
        this.currentCustomer = null;
        this.userRole = '{{ session.get("role") }}';
        this.username = '{{ session.get("username") }}';
        this.users = [];
        this.customers = [];
        this.campaigns = new Set();
        
        console.log('UnifiedLeadManager: Initializing for role:', this.userRole);
        this.init();
    }
    
    async init() {
        console.log('Initializing Unified Lead Manager for role:', this.userRole);
        
        // Setup role-based features
        if (this.userRole === 'admin') {
            document.getElementById('customerSelectorDiv').style.display = 'flex';
            await this.loadCustomers();
        }
        
        // Load initial data
        await this.loadUsers();
        await this.loadLeads();
        
        // Setup auto-refresh
        setInterval(() => this.refreshLeads(), 60000); // Refresh every minute
    }
    
    async loadCustomers() {
        try {
            const response = await fetch('/admin/customers/api');
            const customers = await response.json();
            this.customers = customers;
            
            const selector = document.getElementById('customerSelector');
            selector.innerHTML = '<option value="">×›×œ ×”×œ×§×•×—×•×ª</option>';
            customers.forEach(customer => {
                if (customer.active) {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = customer.name;
                    selector.appendChild(option);
                }
            });
            
            // Set current customer
            this.currentCustomer = '{{ session.get("selected_customer_id") }}' || null;
            if (this.currentCustomer) {
                selector.value = this.currentCustomer;
                const customer = customers.find(c => c.id == this.currentCustomer);
                if (customer) {
                    document.getElementById('customerName').textContent = `- ${customer.name}`;
                }
            }
        } catch (error) {
            console.error('Error loading customers:', error);
        }
    }
    
    async loadUsers() {
        try {
            const response = await fetch('/admin/users/api');
            const data = await response.json();
            this.users = data.users || [];
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }
    
    async loadLeads() {
        try {
            console.log('Loading leads...');
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            const response = await fetch('/leads');
            console.log('Leads API response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Leads data received:', data);
            
            // Handle different response formats
            if (data.leads && Array.isArray(data.leads)) {
                this.leads = data.leads;
            } else if (Array.isArray(data)) {
                this.leads = data;
            } else {
                console.warn('Unexpected leads data format:', data);
                this.leads = [];
            }
            
            console.log('Loaded', this.leads.length, 'leads');
            
            // Extract campaigns for filter
            this.campaigns.clear();
            this.leads.forEach(lead => {
                if (lead.campaign_name) {
                    this.campaigns.add(lead.campaign_name);
                }
            });
            
            // Update campaign filter
            const campaignFilter = document.getElementById('campaignFilter');
            campaignFilter.innerHTML = '<option value="">×›×œ ×”×§××¤×™×™× ×™×</option>';
            Array.from(this.campaigns).sort().forEach(campaign => {
                const option = document.createElement('option');
                option.value = campaign;
                option.textContent = campaign.substring(0, 30) + (campaign.length > 30 ? '...' : '');
                campaignFilter.appendChild(option);
            });
            
            this.applyFilters();
            
        } catch (error) {
            console.error('Error loading leads:', error);
            this.showToast(`×©×’×™××” ×‘×˜×¢×™× ×ª ×”×œ×™×“×™×: ${error.message}`, 'error');
            this.leads = [];
            this.applyFilters();
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }
    
    applyFilters() {
        const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const assignmentFilter = document.getElementById('assignmentFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;
        const campaignFilter = document.getElementById('campaignFilter').value;
        
        this.filteredLeads = this.leads.filter(lead => {
            // Search filter
            if (searchTerm) {
                const searchableText = `${lead.name} ${lead.phone} ${lead.email} ${lead.campaign_name}`.toLowerCase();
                if (!searchableText.includes(searchTerm)) return false;
            }
            
            // Status filter
            if (statusFilter) {
                if (statusFilter === 'not_closed') {
                    // ×œ× ×¡×’×•×¨ - exclude only 'closed' status
                    if (lead.status === 'closed') return false;
                } else if (lead.status !== statusFilter) {
                    return false;
                }
            }
            
            // Assignment filter
            if (assignmentFilter) {
                if (assignmentFilter === 'unassigned' && lead.assigned_to) return false;
                if (assignmentFilter === 'assigned' && !lead.assigned_to) return false;
                if (assignmentFilter === 'mine' && lead.assigned_to !== this.username) return false;
            }
            
            // Date filter
            if (dateFilter) {
                const leadDate = new Date(lead.created_time || lead.received_at);
                const now = new Date();
                
                if (dateFilter === 'today') {
                    if (leadDate.toDateString() !== now.toDateString()) return false;
                } else if (dateFilter === 'week') {
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    if (leadDate < weekAgo) return false;
                } else if (dateFilter === 'month') {
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    if (leadDate < monthAgo) return false;
                }
            }
            
            // Campaign filter
            if (campaignFilter && lead.campaign_name !== campaignFilter) return false;
            
            return true;
        });
        
        this.renderLeads();
    }
    
    renderLeads() {
        const tbody = document.getElementById('leadsTableBody');
        const cardsContainer = document.getElementById('leadCardsContainer');
        const emptyState = document.getElementById('emptyState');
        
        if (this.filteredLeads.length === 0) {
            tbody.innerHTML = '';
            cardsContainer.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }
        
        emptyState.style.display = 'none';
        
        // Render table for desktop
        tbody.innerHTML = this.filteredLeads.map(lead => {
            const priority = this.calculatePriority(lead);
            const priorityClass = priority >= 70 ? 'priority-high' : priority >= 40 ? 'priority-medium' : 'priority-low';
            const priorityIcon = priority >= 70 ? 'ğŸ”¥' : priority >= 40 ? 'âš¡' : 'ğŸ”µ';
            
            return `
                <tr data-lead-id="${lead.id}">
                    <td>
                        <input type="checkbox" class="lead-checkbox" value="${lead.id}" 
                               onchange="UnifiedLeadManager.toggleLead(${lead.id}, this.checked)"
                               title="×‘×—×¨ ××ª ×”×œ×™×“ ${lead.name || '×–×”'} ×œ×‘×™×¦×•×¢ ×¤×¢×•×œ×•×ª ×§×‘×•×¦×ª×™×•×ª">
                    </td>
                    <td>
                        <button class="action-btn btn-primary" onclick="window.UnifiedLeadManager.viewLead(${lead.id})" 
                                title="×”×¦×’ ×¤×¨×˜×™× ××œ××™× ×•×¤×¢×™×œ×•×™×•×ª ×©×œ ${lead.name || '×”×œ×™×“'}">ğŸ‘ï¸</button>
                        ${lead.phone ? `
                            <a href="tel:${lead.phone}" class="action-btn btn-call" 
                               title="×”×ª×§×©×¨ ×œ-${lead.name || '×œ×™×“'} ×‘×˜×œ×¤×•×Ÿ ${lead.phone}">ğŸ“</a>
                            <a href="https://wa.me/${this.formatPhoneForWhatsApp(lead.phone)}" 
                               target="_blank" class="action-btn btn-whatsapp" 
                               title="×©×œ×— ×”×•×“×¢×ª WhatsApp ×œ-${lead.name || '×œ×™×“'} (${lead.phone})">ğŸ’¬</a>
                        ` : ''}
                        ${lead.email ? `
                            <a href="mailto:${lead.email}" class="action-btn btn-email" 
                               title="×©×œ×— ××™××™×™×œ ×œ-${lead.name || '×œ×™×“'} ×‘×›×ª×•×‘×ª ${lead.email}">âœ‰ï¸</a>
                        ` : ''}
                        ${this.canAssign() ? `
                            <button class="action-btn btn-assign" onclick="window.UnifiedLeadManager.quickAssign(${lead.id})" 
                                    title="×”×§×¦×” ××ª ×”×œ×™×“ ${lead.name || '×–×”'} ×œ××©×ª××© ××—×¨">ğŸ‘¤</button>
                        ` : ''}
                    </td>
                    <td>
                        <span class="status-badge status-${lead.status}" 
                              onclick="window.UnifiedLeadManager.quickStatusChange(${lead.id})"
                              oncontextmenu="window.UnifiedLeadManager.closeLeadDirectly(${lead.id}); return false;"
                              title="×œ×—×™×¦×” ×©×××œ: ×¡×˜×˜×•×¡ ×”×‘× | ×œ×—×™×¦×” ×™××™×Ÿ: ×¡×’×™×¨×”">
                            ${this.getStatusLabel(lead.status)}
                        </span>
                    </td>
                    <td><strong>${lead.name || '×œ× ×¦×•×™×Ÿ'}</strong></td>
                    <td title="${lead.campaign_name || ''}">${(lead.campaign_name || '-').substring(0, 30)}</td>
                    <td>${lead.assigned_full_name || lead.assigned_to || '×œ× ××•×§×¦×”'}</td>
                    <td>${this.formatDate(lead.created_time || lead.received_at)}</td>
                </tr>
            `;
        }).join('');
        
        // Render cards for mobile
        cardsContainer.innerHTML = this.filteredLeads.map(lead => {
            const priority = this.calculatePriority(lead);
            const priorityClass = priority >= 70 ? 'priority-high' : priority >= 40 ? 'priority-medium' : 'priority-low';
            const priorityIcon = priority >= 70 ? 'ğŸ”¥' : priority >= 40 ? 'âš¡' : 'ğŸ”µ';
            
            return `
                <div class="lead-card" data-lead-id="${lead.id}">
                    <div class="lead-card-header">
                        <div>
                            <div class="lead-card-name">${lead.name || '×œ× ×¦×•×™×Ÿ'}</div>
                        </div>
                        <div class="lead-card-status">
                            <span class="status-badge status-${lead.status}"
                                  onclick="window.UnifiedLeadManager.quickStatusChange(${lead.id})"
                                  oncontextmenu="window.UnifiedLeadManager.closeLeadDirectly(${lead.id}); return false;"
                                  title="×œ×—×™×¦×” ×©×××œ: ×¡×˜×˜×•×¡ ×”×‘× | ×œ×—×™×¦×” ×™××™×Ÿ: ×¡×’×™×¨×”">
                                ${this.getStatusLabel(lead.status)}
                            </span>
                        </div>
                    </div>
                    
                    <div class="lead-card-info">
                        <div style="font-size: 16px; margin-bottom: 8px;"><strong>×§××¤×™×™×Ÿ:</strong> ${(lead.campaign_name || '×œ× ×¦×•×™×Ÿ').substring(0, 40)}</div>
                        <div style="display: flex; justify-content: space-between;">
                            <div><strong>×ª××¨×™×š:</strong> ${this.formatDate(lead.created_time || lead.received_at)}</div>
                        </div>
                        <div style="margin-top: 8px;"><strong>××•×§×¦×” ×œ:</strong> ${lead.assigned_to || '×œ× ××•×§×¦×”'}</div>
                    </div>
                    
                    <div class="lead-card-actions">
                        <button class="action-btn btn-primary" onclick="window.UnifiedLeadManager.viewLead(${lead.id})" 
                                title="×¦×¤×” ×‘×¤×¨×˜×™× ×”××œ××™× ×©×œ ${lead.name || '×”×œ×™×“'}">ğŸ‘ï¸</button>
                        ${lead.phone ? `
                            <a href="tel:${lead.phone}" class="action-btn btn-call" 
                               title="×”×ª×§×©×¨ ×œ-${lead.name || '×œ×™×“'}: ${lead.phone}">ğŸ“</a>
                            <a href="https://wa.me/${this.formatPhoneForWhatsApp(lead.phone)}" 
                               target="_blank" class="action-btn btn-whatsapp" 
                               title="×¤×ª×— WhatsApp ×¢× ${lead.name || '×œ×™×“'}: ${lead.phone}">ğŸ’¬</a>
                        ` : ''}
                        ${lead.email ? `
                            <a href="mailto:${lead.email}" class="action-btn btn-email" 
                               title="×©×œ×— ××™××™×™×œ ×œ-${lead.name || '×œ×™×“'}: ${lead.email}">âœ‰ï¸</a>
                        ` : ''}
                        ${this.canAssign() ? `
                            <button class="action-btn btn-assign" onclick="window.UnifiedLeadManager.quickAssign(${lead.id})" 
                                    title="×”×§×¦×” ××ª ${lead.name || '×”×œ×™×“'} ×œ××©×ª××© ××—×¨">ğŸ‘¤</button>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    calculatePriority(lead) {
        let score = 0;
        
        // New lead bonus
        if (lead.status === 'new') score += 30;
        
        // Contact info completeness
        if (lead.phone) score += 20;
        if (lead.email) score += 10;
        
        // Time decay (newer = higher priority)
        const ageInDays = (Date.now() - new Date(lead.created_time || lead.received_at)) / (1000 * 60 * 60 * 24);
        if (ageInDays <= 1) score += 30;
        else if (ageInDays <= 3) score += 20;
        else if (ageInDays <= 7) score += 10;
        
        // Not assigned bonus
        if (!lead.assigned_to) score += 10;
        
        return Math.min(100, score);
    }
    
    canAssign() {
        return this.userRole === 'admin' || this.userRole === 'campaign_manager';
    }
    
    getStatusLabel(status) {
        const labels = {
            'new': '×—×“×©',
            'contacted': '× ×•×¦×¨ ×§×©×¨',
            'qualified': '××•×›×©×¨',
            'interested': '××ª×¢× ×™×™×Ÿ',
            'not_interested': '×œ× ××ª×¢× ×™×™×Ÿ',
            'callback': '×—×–×¨×”',
            'interview_scheduled': '××ª×•×× ×¨××™×•×Ÿ',
            'hired': '×”×ª×§×‘×œ',
            'rejected': '× ×“×—×”',
            'closed': '×¡×’×•×¨'
        };
        return labels[status] || status;
    }
    
    formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString('he-IL');
    }
    
    formatPhoneForWhatsApp(phone) {
        if (!phone) return '';
        
        // Remove all non-digit characters
        let cleanPhone = phone.replace(/[^0-9]/g, '');
        
        // Handle Israeli phone numbers
        if (cleanPhone.startsWith('972')) {
            // Already has country code
            return cleanPhone;
        } else if (cleanPhone.startsWith('0')) {
            // Remove leading 0 and add Israel country code
            return '972' + cleanPhone.substring(1);
        } else if (cleanPhone.length === 9) {
            // 9 digits without leading 0, add country code
            return '972' + cleanPhone;
        } else if (cleanPhone.length === 10 && cleanPhone.startsWith('0')) {
            // 10 digits with leading 0
            return '972' + cleanPhone.substring(1);
        } else {
            // Default: assume it needs Israel country code
            return '972' + cleanPhone;
        }
    }
    
    updateStats() {
        // Stats removed from UI - no longer needed
    }
    
    async viewLead(leadId) {
        const lead = this.leads.find(l => l.id === leadId);
        if (!lead) return;
        
        try {
            const response = await fetch(`/leads/${leadId}`);
            const data = await response.json();
            
            if (data.lead) {
                this.showLeadModal(data.lead, data.activities || []);
            }
        } catch (error) {
            console.error('Error loading lead details:', error);
        }
    }
    
    showLeadModal(lead, activities) {
        const modal = document.getElementById('leadModal');
        const modalBody = document.getElementById('leadModalBody');
        const modalTitle = document.getElementById('leadModalTitle');
        
        modalTitle.textContent = `×¤×¨×˜×™ ×œ×™×“ - ${lead.name || '×œ× ×¦×•×™×Ÿ'}`;
        
        // Parse raw data for Zapier information
        let rawData = {};
        try {
            rawData = lead.raw_data ? (typeof lead.raw_data === 'string' ? JSON.parse(lead.raw_data) : lead.raw_data) : {};
        } catch (e) {
            console.error('Error parsing raw data:', e);
        }
        
        // Extract Facebook lead form info
        const leadFormId = rawData['××–×”×” ×˜×•×¤×¡ ×œ×™×“×™×'] || rawData.lead_form_id || rawData.form_id;
        const facebookPageId = rawData.page_id || rawData.facebook_page_id;
        const leadId = lead.external_lead_id;
        
        modalBody.innerHTML = `
            <!-- Basic Lead Information -->
            <div style="background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="margin-bottom: 15px; color: #1e293b;">ğŸ‘¤ ×¤×¨×˜×™ ×”×œ×™×“</h3>
                        <div style="display: grid; gap: 12px;">
                            <div><strong>×©× ××œ×:</strong> ${lead.name || '×œ× ×¦×•×™×Ÿ'}</div>
                            <div><strong>×˜×œ×¤×•×Ÿ:</strong> ${lead.phone ? `<a href="tel:${lead.phone}" style="color: #059669;">${lead.phone}</a>` : '×œ× ×¦×•×™×Ÿ'}</div>
                            <div><strong>××™××™×™×œ:</strong> ${lead.email ? `<a href="mailto:${lead.email}" style="color: #059669;">${lead.email}</a>` : '×œ× ×¦×•×™×Ÿ'}</div>
                            
                            <!-- Facebook Lead Management Links -->
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);">
                                <div style="margin-bottom: 8px;"><strong>× ×™×”×•×œ ×”×œ×™×“ ×‘×¤×™×™×¡×‘×•×§:</strong></div>
                                
                                ${leadFormId ? `
                                    <div style="margin-bottom: 8px;">
                                        <a href="https://business.facebook.com/latest/lead_access/leads?form_id=${leadFormId}" target="_blank" style="color: #1877f2;">
                                            ğŸ“‹ ×˜×•×¤×¡ ×œ×™×“×™×: ${leadFormId}
                                        </a>
                                    </div>
                                ` : ''}
                                
                                ${facebookPageId && leadId ? `
                                    <div style="margin-bottom: 8px;">
                                        <a href="https://business.facebook.com/latest/lead_access/leads?page_id=${facebookPageId}&lead_id=${leadId}" target="_blank" style="color: #1877f2;">
                                            ğŸ¯ ×”×œ×™×“ ×”×¡×¤×¦×™×¤×™ ×‘×¤×™×™×¡×‘×•×§
                                        </a>
                                    </div>
                                ` : ''}
                                
                                ${lead.platform === 'fb' || lead.platform === 'ig' ? `
                                    <div style="margin-bottom: 8px;">
                                        <a href="https://business.facebook.com/latest/lead_access/leads" target="_blank" style="color: #4267B2;">
                                            ğŸ“Š ×›×œ ×”×œ×™×“×™× ×‘-Meta Business
                                        </a>
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <a href="https://business.facebook.com/latest/inbox" target="_blank" style="color: #4267B2;">
                                            ğŸ’¬ ×”×•×“×¢×•×ª Meta Business Suite
                                        </a>
                                    </div>
                                ` : ''}
                                
                                ${lead.external_lead_id ? `
                                    <div style="margin-bottom: 8px;">
                                        <strong>××–×”×” ×œ×™×“:</strong> <code style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 12px;">${lead.external_lead_id}</code>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 15px; color: #1e293b;">ğŸ“Š ××¦×‘ ×”×œ×™×“</h3>
                        <div style="display: grid; gap: 12px;">
                            <div><strong>×¡×˜×˜×•×¡ × ×•×›×—×™:</strong> <span class="status-badge status-${lead.status}" style="margin-right: 8px;">${this.getStatusLabel(lead.status)}</span></div>
                            <div><strong>××•×§×¦×” ×œ:</strong> ${lead.assigned_to || '×œ× ××•×§×¦×”'}</div>
                            <div><strong>×ª××¨×™×š ×§×‘×œ×”:</strong> ${this.formatDate(lead.created_time || lead.received_at)}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Campaign & Source Information -->
            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; color: #1e293b;">ğŸ¯ ××§×•×¨ ×”×œ×™×“ ×•××™×§×•×“</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div style="margin-bottom: 10px;"><strong>×¤×œ×˜×¤×•×¨××”:</strong> ${lead.platform === 'fb' ? 'Facebook' : lead.platform === 'ig' ? 'Instagram' : lead.platform || '×œ× ×¦×•×™×Ÿ'}</div>
                        <div style="margin-bottom: 10px;"><strong>×©× ×§××¤×™×™×Ÿ:</strong> ${lead.campaign_name || '×œ× ×¦×•×™×Ÿ'}</div>
                        <div><strong>×©× ×”×˜×•×¤×¡:</strong> ${lead.form_name || '×œ× ×¦×•×™×Ÿ'}</div>
                    </div>
                    <div>
                        <div style="margin-bottom: 10px;"><strong>××§×•×¨ ×œ×™×“:</strong> ${lead.lead_source || '×œ× ×¦×•×™×Ÿ'}</div>
                        <div style="margin-bottom: 10px;"><strong>ID ×—×™×¦×•× ×™:</strong> ${lead.external_lead_id || '×œ× ×¦×•×™×Ÿ'}</div>
                        <div><strong>×¢×“×™×¤×•×ª:</strong> ${lead.priority || '×¨×’×™×œ×”'}</div>
                    </div>
                </div>
            </div>
            
            <!-- Meta Form Responses (Meta Style Format) -->
            ${Object.keys(rawData).length > 0 ? `
                <div style="background: #ffffff; padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #1877f2; box-shadow: 0 4px 12px rgba(24,119,242,0.15);">
                    <div style="border-bottom: 2px solid #1877f2; padding-bottom: 15px; margin-bottom: 20px;">
                        <h3 style="color: #1877f2; margin: 0; font-size: 1.4em;">ğŸ“‹ ×”×ª×©×•×‘×•×ª ×©×œ ×”×˜×•×¤×¡</h3>
                        <div style="margin-top: 10px; color: #65676b; font-size: 0.9em;">
                            ${leadFormId ? `
                                <div style="margin-bottom: 5px;">
                                    <strong>××–×”×” ×˜×•×¤×¡ ×œ×™×“×™×:</strong> <code style="background: #f0f2f5; padding: 2px 6px; border-radius: 4px;">${leadFormId}</code>
                                </div>
                            ` : ''}
                            <div><strong>× ×©×œ×— ×‘-</strong> ${this.formatDate(lead.created_time || lead.received_at)}</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 18px;">
                        ${Object.entries(rawData)
                            .filter(([key, value]) => value != null && value !== '' && 
                                !['××–×”×” ×˜×•×¤×¡ ×œ×™×“×™×', 'lead_form_id', 'form_id', 'page_id', 'facebook_page_id'].includes(key))
                            .map(([key, value]) => {
                                // Handle different data types
                                let displayValue = value;
                                if (typeof value === 'object') {
                                    displayValue = JSON.stringify(value, null, 2);
                                }
                                return `
                                    <div style="border-bottom: 1px solid #dadde1; padding-bottom: 12px;">
                                        <div style="font-weight: 600; color: #1c1e21; margin-bottom: 6px; font-size: 15px;">
                                            ${key}
                                        </div>
                                        <div style="color: #65676b; font-size: 14px; line-height: 1.4; white-space: pre-wrap;">
                                            ${displayValue}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        
                        ${Object.entries(rawData).filter(([key, value]) => value != null && value !== '' && 
                            !['××–×”×” ×˜×•×¤×¡ ×œ×™×“×™×', 'lead_form_id', 'form_id', 'page_id', 'facebook_page_id'].includes(key)).length === 0 ? 
                            '<div style="text-align: center; color: #65676b; font-style: italic; padding: 20px;">××™×Ÿ ×ª×©×•×‘×•×ª ×˜×•×¤×¡ ×–××™× ×•×ª</div>' : ''}
                    </div>
                    
                    ${leadFormId ? `
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #dadde1;">
                            <a href="https://business.facebook.com/latest/lead_access/leads?form_id=${leadFormId}" 
                               target="_blank" 
                               style="display: inline-block; background: #1877f2; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; font-weight: 600;">
                                ğŸ” ×œ×”×¦×’×ª ×”×˜×•×¤×¡ ×‘××˜×
                            </a>
                        </div>
                    ` : ''}
                </div>
            ` : '<div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; color: #6b7280;">××™×Ÿ × ×ª×•× ×™× ××”×˜×•×¤×¡</div>'}

            <!-- Notes Section -->
            ${lead.notes ? `
                <div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #1e293b;">ğŸ“ ×”×¢×¨×•×ª</h3>
                    <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 8px;">
                        ${lead.notes}
                    </div>
                </div>
            ` : ''}
            
            <!-- Activity History -->
            <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                <h3 style="margin-bottom: 15px; color: #1e293b;">ğŸ“ˆ ×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×™×œ×•×ª</h3>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${activities.length > 0 ? activities.map(activity => `
                        <div style="padding: 15px; background: white; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="background: #059669; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600;">
                                    ${this.getActivityLabel(activity.activity_type)}
                                </span>
                                <span style="color: #6b7280; font-size: 0.9em;">${this.formatDate(activity.created_at)}</span>
                            </div>
                            <div style="color: #374151;">${activity.description || '××™×Ÿ ×ª×™××•×¨'}</div>
                            ${activity.user_name ? `<div style="color: #6b7280; font-size: 0.85em; margin-top: 4px;">×¢×œ ×™×“×™: ${activity.user_name}</div>` : ''}
                        </div>
                    `).join('') : '<div style="text-align: center; color: #6b7280; font-style: italic; padding: 40px;">××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ×¨×©×•××•×ª ×¢×“×™×™×Ÿ</div>'}
                </div>
            </div>
        `;
        
        modal.style.display = 'block';
    }
    
    getActivityLabel(type) {
        const labels = {
            'lead_received': '×œ×™×“ ×”×ª×§×‘×œ',
            'status_change': '×©×™× ×•×™ ×¡×˜×˜×•×¡',
            'assignment': '×”×§×¦××”',
            'call': '×©×™×—×”',
            'note_added': '×”×¢×¨×”'
        };
        return labels[type] || type;
    }
    
    closeModal() {
        document.getElementById('leadModal').style.display = 'none';
    }
    
    async quickAssign(leadId) {
        // Implementation for quick assignment
        const lead = this.leads.find(l => l.id === leadId);
        if (!lead) return;
        
        try {
            // Load available users for assignment
            const response = await fetch('/admin/users/api');
            if (!response.ok) {
                throw new Error('Failed to load users');
            }
            
            const users = await response.json();
            
            // Create assignment modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>×”×§×¦××ª ×œ×™×“: ${lead.name || '×œ× ×¦×•×™×Ÿ'}</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">âœ–ï¸</button>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 15px;">×‘×—×¨ ××©×ª××© ×œ×”×§×¦××ª ×”×œ×™×“:</p>
                        <select id="assignUserSelect" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                            <option value="">×‘×—×¨ ××©×ª××©...</option>
                            <option value="">×‘×™×˜×•×œ ×”×§×¦××” (×œ× ××•×§×¦×”)</option>
                            ${users.map(user => `
                                <option value="${user.username}" ${lead.assigned_to === user.username ? 'selected' : ''}>
                                    ${user.full_name} (${user.username})
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button class="action-btn btn-primary" onclick="window.UnifiedLeadManager.performAssignment(${leadId}, document.getElementById('assignUserSelect').value, this.closest('.modal-overlay'))">
                            ×”×§×¦×”
                        </button>
                        <button class="action-btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                            ×‘×™×˜×•×œ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
        } catch (error) {
            console.error('Error loading users for assignment:', error);
            this.showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª ×”××©×ª××©×™×', 'error');
        }
    }
    
    async performAssignment(leadId, assignedTo, modal) {
        try {
            const response = await fetch(`/leads/${leadId}/assign`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ assigned_to: assignedTo })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                this.showToast(result.message || '×”×œ×™×“ ×”×•×§×¦×” ×‘×”×¦×œ×—×”', 'success');
                await this.loadLeads();
                modal.remove();
            } else {
                this.showToast(result.error || '×©×’×™××” ×‘×”×§×¦××ª ×”×œ×™×“', 'error');
            }
        } catch (error) {
            console.error('Assignment error:', error);
            this.showToast('×©×’×™××” ×‘×”×§×¦××ª ×”×œ×™×“', 'error');
        }
    }
    
    async quickStatusChange(leadId) {
        const lead = this.leads.find(l => l.id === leadId);
        if (!lead) return;
        
        // Define status progression flow
        const statusFlow = {
            'new': 'contacted',
            'contacted': 'qualified', 
            'qualified': 'interested',
            'interested': 'hired',
            'hired': 'closed',
            'rejected': 'closed',
            'closed': 'new'
        };
        
        // Get next status
        const nextStatus = statusFlow[lead.status] || 'contacted';
        
        // Update status directly
        await this.performStatusChange(leadId, nextStatus, null);
    }
    
    async closeLeadDirectly(leadId) {
        // Direct close without progression
        await this.performStatusChange(leadId, 'closed', null);
    }
    
    async performStatusChange(leadId, newStatus, modal) {
        try {
            const response = await fetch(`/leads/${leadId}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    status: newStatus,
                    user_name: this.fullName || this.username || '××©×ª××©'
                })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                this.showToast(result.message || '×¡×˜×˜×•×¡ ×”×œ×™×“ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”', 'success');
                await this.loadLeads();
                if (modal) modal.remove();
            } else {
                this.showToast(result.error || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”×œ×™×“', 'error');
            }
        } catch (error) {
            console.error('Status change error:', error);
            this.showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”×œ×™×“', 'error');
        }
    }
    
    async changeCustomer(customerId) {
        // Admin only - change selected customer
        try {
            const response = await fetch('/admin/select-customer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ customer_id: customerId })
            });
            
            if (response.ok) {
                this.currentCustomer = customerId;
                await this.loadLeads();
                
                const customer = this.customers.find(c => c.id == customerId);
                document.getElementById('customerName').textContent = customer ? `- ${customer.name}` : '';
            }
        } catch (error) {
            console.error('Error changing customer:', error);
        }
    }
    
    toggleSelectAll(checked) {
        const checkboxes = document.querySelectorAll('.lead-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = checked;
            const leadId = parseInt(cb.value);
            if (checked) {
                this.selectedLeads.add(leadId);
            } else {
                this.selectedLeads.delete(leadId);
            }
        });
    }
    
    toggleLead(leadId, checked) {
        if (checked) {
            this.selectedLeads.add(leadId);
        } else {
            this.selectedLeads.delete(leadId);
        }
    }
    
    async refreshLeads() {
        await this.loadLeads();
        this.showToast('×”×¨×©×™××” ×¢×•×“×›× ×”', 'success');
    }
    
    async refreshAndApplyFilters() {
        // Refresh leads from server and then apply filters
        await this.loadLeads();
    }
    
    exportLeads() {
        // Implementation for export to Excel
        this.showToast('×”×™×™×¦×•× ×œ××§×¡×œ ×™×ª×—×™×œ ×‘×§×¨×•×‘', 'info');
    }
    
    showToast(message, type = 'success') {
        // Create toast notification
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
}

// Initialize on page load
let UnifiedLeadManager;

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        window.UnifiedLeadManager = new UnifiedLeadManagerClass();
    });
} else {
    window.UnifiedLeadManager = new UnifiedLeadManagerClass();
}

// Add animations and modal styles
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    
    /* Modal positioning - show at top */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 10000;
        overflow-y: auto;
        padding: 20px;
        box-sizing: border-box;
    }
    
    .modal .modal-content {
        background: white;
        margin: 0 auto;
        border-radius: 10px;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px 10px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal .modal-header .close {
        font-size: 28px;
        cursor: pointer;
        background: none;
        border: none;
        color: white;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal .modal-body {
        padding: 20px;
        max-height: calc(90vh - 100px);
        overflow-y: auto;
    }
`;
document.head.appendChild(style);
</script>