<!-- ENHANCED MOBILE v1.6 - Unified Lead Management Component -->
<!-- Modern UX improvements with touch optimization -->

<style>
    /* Modern Lead Manager Styles */
    .lead-manager-container {
        background: linear-gradient(135deg, #fef7cd 0%, #fef3c7 100%);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        margin: 20px 0;
    }
    
    /* Header Section */
    .lead-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .lead-title {
        font-size: 1.8em;
        font-weight: bold;
        color: #059669;
        display: flex;
        align-items: center;
        gap: 10px;
        text-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .lead-title::before {
        content: "📱 v3.22 ";
        font-size: 0.8em;
        color: #10b981;
    }
    
    .lead-stats {
        display: flex;
        gap: 20px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        padding: 10px 20px;
        border-radius: 10px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #059669;
    }
    
    .stat-label {
        font-size: 0.9em;
        color: #6b7280;
    }
    
    /* Control Panel */
    .control-panel {
        background: #f8fafc;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .filter-label {
        font-size: 0.85em;
        color: #6b7280;
        font-weight: 600;
    }
    
    .filter-select, .filter-input {
        padding: 10px 15px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        background: linear-gradient(135deg, #fef7cd 0%, #fef3c7 100%);
        font-size: 14px;
        min-width: 150px;
        transition: all 0.2s;
    }
    
    .filter-select:focus, .filter-input:focus {
        border-color: #059669;
        outline: none;
        box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }
    
    /* Customer Selector for Admin */
    .customer-selector {
        background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .customer-selector select {
        background: linear-gradient(135deg, #fef7cd 0%, #fef3c7 100%);
        color: #1e293b;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        font-weight: 600;
    }
    
    /* Filter Chips */
    .filter-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-bottom: 20px;
    }
    
    .filter-chip {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border: 2px solid #e2e8f0;
        color: #6b7280;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s ease;
        user-select: none;
        white-space: nowrap;
    }
    
    .filter-chip:hover {
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        border-color: #cbd5e1;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .filter-chip.active {
        background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        border-color: #059669;
        color: white;
        box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
    }
    
    .filter-chip.active:hover {
        background: linear-gradient(135deg, #047857 0%, #059669 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(5, 150, 105, 0.4);
    }

    /* Action Buttons */
    .action-btn {
        padding: 10px 16px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        text-decoration: none;
    }
    
    .btn-primary {
        background: #3b82f6;
        color: white;
    }
    
    .btn-primary:hover {
        background: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn-call {
        background: #10b981;
        color: white;
    }
    
    .btn-call:hover {
        background: #059669;
        transform: translateY(-1px);
    }
    
    .btn-whatsapp {
        background: #25d366;
        color: white;
    }
    
    .btn-whatsapp:hover {
        background: #128c7e;
        transform: translateY(-1px);
    }
    
    .btn-email {
        background: #8b5cf6;
        color: white;
    }
    
    .btn-email:hover {
        background: #7c3aed;
        transform: translateY(-1px);
    }
    
    .btn-assign {
        background: #f59e0b;
        color: white;
    }
    
    .btn-assign:hover {
        background: #d97706;
        transform: translateY(-1px);
    }
    
    .btn-delete {
        background: #ef4444;
        color: white;
    }
    
    .btn-delete:hover {
        background: #dc2626;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    /* Lead Cards for Mobile */
    .lead-cards-container {
        display: none; /* Hidden by default, shown on mobile */
    }
    
    .lead-card {
        background: linear-gradient(135deg, #fef7cd 0%, #fef3c7 100%);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid #e2e8f0;
        position: relative;
        overflow: hidden;
        transition: all 0.2s ease;
    }
    
    /* Status indicator bar */
    .lead-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        left: 0;
        height: 4px;
        background: #e5e7eb;
    }
    
    .lead-card.status-new::before { background: #059669; }
    .lead-card.status-contacted::before { background: #3b82f6; }
    .lead-card.status-qualified::before { background: #f59e0b; }
    .lead-card.status-interested::before { background: #22c55e; }
    .lead-card.status-hired::before { background: #10b981; }
    .lead-card.status-rejected::before { background: #ef4444; }
    .lead-card.status-closed::before { background: #9ca3af; }
    
    .lead-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }
    
    .lead-card-name {
        font-size: 16px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 4px;
    }
    
    .lead-card-phone {
        font-size: 14px;
        color: #6b7280;
        direction: ltr;
        text-align: right;
    }
    
    .lead-card-status {
        flex-shrink: 0;
    }
    
    .lead-card-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 12px;
        font-size: 13px;
        color: #6b7280;
    }
    
    .lead-card-actions {
        display: flex;
        gap: 8px;
        justify-content: center;
    }
    
    .lead-card-actions .action-btn {
        flex: 1;
        max-width: 80px;
        padding: 12px;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 44px; /* iOS/Android standard touch target */
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        color: #4b5563;
        background: linear-gradient(135deg, #fef7cd 0%, #fef3c7 100%);
        font-weight: 500;
        margin: 0 2px;
    }
    
    .lead-card-actions .action-btn:active {
        background: #f3f4f6;
        transform: scale(0.98);
        border-color: #d1d5db;
    }

    /* Lead Table for Desktop */
    .lead-table-container {
        display: block; /* Shown by default, hidden on mobile */
    }
    
    .lead-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: linear-gradient(135deg, #fef7cd 0%, #fef3c7 100%);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .lead-table thead {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        color: white;
    }
    
    .lead-table th {
        padding: 15px;
        text-align: right;
        font-weight: 600;
        font-size: 14px;
        white-space: nowrap;
    }
    
    .lead-table tbody tr {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border-bottom: 1px solid #f1f5f9;
        transition: all 0.2s;
    }
    
    .lead-table tbody tr:hover {
        background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
        transform: scale(1.01);
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .lead-table td {
        padding: 12px 15px;
        font-size: 14px;
    }
    
    /* Status Badges */
    .status-badge {
        padding: 8px 16px;
        border-radius: 25px;
        font-size: 13px;
        font-weight: 700;
        display: inline-block;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
        user-select: none;
        position: relative;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        border-color: rgba(255,255,255,0.4);
        filter: brightness(1.1);
        z-index: 10;
    }
    
    .status-badge:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    
    .status-badge::after {
        content: "שמאל: הבא | ימין: סגור";
        position: absolute;
        bottom: -25px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        pointer-events: none;
        z-index: 1000;
        font-weight: normal;
        text-transform: none;
        letter-spacing: normal;
    }
    
    .status-badge:hover::after {
        opacity: 1;
        visibility: visible;
        bottom: -30px;
    }
    
    .status-new { background: #dbeafe; color: #1e40af; }
    .status-contacted { background: #fed7aa; color: #92400e; }
    .status-qualified { background: #d1fae5; color: #065f46; }
    .status-interested { background: #e9d5ff; color: #6b21a8; }
    .status-hired { background: #a7f3d0; color: #047857; }
    .status-rejected { background: #fecaca; color: #991b1b; }
    .status-closed { background: #e5e7eb; color: #374151; }
    
    /* Priority Indicators */
    .priority-high {
        color: #dc2626;
        font-weight: bold;
    }
    
    .priority-medium {
        color: #f59e0b;
        font-weight: 600;
    }
    
    .priority-low {
        color: #6b7280;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px;
        color: #6b7280;
    }
    
    .empty-state-icon {
        font-size: 4em;
        margin-bottom: 20px;
        opacity: 0.3;
    }
    
    /* Loading State */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e2e8f0;
        border-top-color: #059669;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Mobile-first: Leads at top, filters at bottom */
    .lead-manager-container {
        display: flex;
        flex-direction: column;
    }
    
    .leads-display {
        order: 1; /* Leads always first */
    }
    
    .control-panel {
        order: 2; /* Filters always second */
    }
    
    /* Mobile Design */
    @media (max-width: 768px) {
        .lead-cards-container {
            display: block; /* Show cards on mobile */
        }
        
        .lead-table-container {
            display: none; /* Hide table on mobile */
        }
        
        /* Enhanced mobile status badges */
        .status-badge {
            min-height: 44px; /* Touch target standard */
            min-width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            border-radius: 20px;
            font-weight: 600;
            transition: all 0.2s ease;
            position: relative;
            z-index: 10;
        }
        
        .status-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .status-badge:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        /* Ensure mobile status badges are always clickable */
        .lead-card .status-badge {
            pointer-events: auto;
            touch-action: manipulation;
        }
        
        /* Mobile-friendly status change modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            width: 100vw;
            height: 100vh;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #fef7cd 0%, #fef3c7 100%);
            border-radius: 16px;
            width: 90vw;
            max-width: 400px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin: 0 auto;
            position: relative;
            transform: translateZ(0); /* Force hardware acceleration */
        }
        
        /* Ensure modal is always centered on mobile */
        @media (max-width: 768px) {
            .modal-overlay {
                overflow: hidden;
            }
            
            .modal-overlay .modal-content {
                transform: none;
                margin: 0;
            }
        }
        
        /* Mobile status selection with large touch targets */
        .mobile-status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 16px;
        }
        
        .mobile-status-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 8px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: linear-gradient(135deg, #fef7cd 0%, #fef3c7 100%);
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 60px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .mobile-status-btn:active {
            transform: scale(0.95);
            background: #f8fafc;
        }
        
        .status-icon {
            font-size: 18px;
        }
        
        /* Status-specific colors for mobile buttons */
        .mobile-status-btn.status-new { border-color: #059669; color: #059669; }
        .mobile-status-btn.status-contacted { border-color: #3b82f6; color: #3b82f6; }
        .mobile-status-btn.status-qualified { border-color: #f59e0b; color: #f59e0b; }
        .mobile-status-btn.status-interested { border-color: #22c55e; color: #22c55e; }
        .mobile-status-btn.status-hired { border-color: #10b981; color: #10b981; }
        .mobile-status-btn.status-rejected { border-color: #ef4444; color: #ef4444; }
        .mobile-status-btn.status-closed { border-color: #9ca3af; color: #9ca3af; }
        
        .control-panel {
            flex-direction: column;
            align-items: stretch;
            margin-top: 20px;
            margin-bottom: 0;
        }
        
        .action-btn {
            padding: 10px 12px;
            font-size: 14px;
            min-height: 44px; /* Touch-friendly */
        }
        
        .lead-header {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }
        
        .lead-title {
            justify-content: center;
        }
    }
    
    /* Desktop Design */
    @media (min-width: 769px) {
        .lead-cards-container {
            display: none; /* Hide cards on desktop */
        }
        
        .lead-table-container {
            display: block; /* Show table on desktop */
        }
    }
</style>

<div class="lead-manager-container">
    <!-- Leads Display (Cards + Table) -->
    <div class="leads-display" style="position: relative;">
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
        </div>
        
        <!-- Mobile Cards -->
        <div class="lead-cards-container" id="leadCardsContainer">
            <!-- Lead cards will be populated here -->
        </div>
        
        <!-- Desktop Table -->
        <div class="lead-table-container" style="overflow-x: auto;">
            <table class="lead-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="selectAll" onchange="UnifiedLeadManager.toggleSelectAll(this.checked)"
                                   title="בחר/בטל בחירה של כל הלידים המוצגים">
                        </th>
                        <th>פעולות</th>
                        <th>סטטוס</th>
                        <th>שם</th>
                        <th>קמפיין</th>
                        <th>מוקצה ל</th>
                        <th>תאריך</th>
                    </tr>
                </thead>
                <tbody id="leadsTableBody">
                    <!-- Leads will be populated here -->
                </tbody>
            </table>
        </div>
        
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">📭</div>
            <h3>אין לידים להצגה</h3>
            <p>נסה לשנות את הפילטרים או לרענן את הרשימה</p>
        </div>
    </div>
    
    <!-- Filter Chips (Quick Filters) -->
    <div class="filter-chips" style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
        <button class="filter-chip active" onclick="filterLeadsByType('all')" data-filter="all">
            כל הלידים
        </button>
        <button class="filter-chip" onclick="filterLeadsByType('new')" data-filter="new">
            חדשים
        </button>
        <button class="filter-chip" onclick="filterLeadsByType('contacted')" data-filter="contacted">
            נוצר קשר
        </button>
        <button class="filter-chip" onclick="filterLeadsByType('qualified')" data-filter="qualified">
            מוכשרים
        </button>
        <button class="filter-chip" onclick="filterLeadsByType('interested')" data-filter="interested">
            מתעניינים
        </button>
        <button class="filter-chip" onclick="filterLeadsByType('hired')" data-filter="hired">
            התקבלו
        </button>
        <button class="filter-chip" onclick="filterLeadsByType('rejected')" data-filter="rejected">
            נדחו
        </button>
        <button class="filter-chip" onclick="filterLeadsByType('closed')" data-filter="closed">
            סגורים
        </button>
        <button class="filter-chip" onclick="filterLeadsByType('unassigned')" data-filter="unassigned">
            לא מוקצים
        </button>
    </div>

    <!-- Control Panel (Filters) -->
    <div class="control-panel">
        <!-- Customer Selector (Admin Only) -->
        <div id="customerSelectorDiv" class="customer-selector" style="display: none;" 
             title="בחר לקוח לצפייה בלידים שלו בלבד">
            <span>🏢 לקוח:</span>
            <select id="customerSelector" onchange="UnifiedLeadManager.changeCustomer(this.value)"
                    title="החלף בין לקוחות שונים לניהול הלידים שלהם">
                <option value="">בחר לקוח</option>
            </select>
        </div>
        
        <!-- Filters -->
        <div class="filter-group">
            <label class="filter-label">🔍 חיפוש</label>
            <input type="text" id="searchFilter" class="filter-input" 
                   placeholder="חפש שם, טלפון, אימייל..." 
                   onkeyup="window.UnifiedLeadManager.applyFilters()"
                   title="חפש לידים לפי שם, מספר טלפון או כתובת אימייל">
        </div>
        
        <div class="filter-group">
            <label class="filter-label">📌 סטטוס</label>
            <select id="statusFilter" class="filter-select" onchange="window.UnifiedLeadManager.refreshAndApplyFilters()"
                    title="סנן לידים לפי סטטוס הטיפול הנוכחי">
                <option value="">כל הסטטוסים</option>
                <option value="not_closed" selected>לא סגור</option>
                <option value="new">חדש</option>
                <option value="contacted">נוצר קשר</option>
                <option value="qualified">מוכשר</option>
                <option value="interested">מתעניין</option>
                <option value="hired">התקבל</option>
                <option value="rejected">נדחה</option>
                <option value="closed">סגור</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">👤 הקצאה</label>
            <select id="assignmentFilter" class="filter-select" onchange="window.UnifiedLeadManager.refreshAndApplyFilters()"
                    title="סנן לידים לפי מצב ההקצאה למשתמשים">
                <option value="">כל ההקצאות</option>
                <option value="unassigned">לא מוקצה</option>
                <option value="assigned">מוקצה</option>
                <option value="mine">שלי</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">📅 תקופה</label>
            <select id="dateFilter" class="filter-select" onchange="window.UnifiedLeadManager.refreshAndApplyFilters()"
                    title="סנן לידים לפי תקופת הגעתם למערכת">
                <option value="">כל הזמן</option>
                <option value="today">היום</option>
                <option value="week">השבוע</option>
                <option value="month">החודש</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">🎯 קמפיין</label>
            <select id="campaignFilter" class="filter-select" onchange="window.UnifiedLeadManager.refreshAndApplyFilters()"
                    title="סנן לידים לפי הקמפיין שמהם הם הגיעו">
                <option value="">כל הקמפיינים</option>
            </select>
        </div>
        
        <!-- Action Buttons -->
        <button class="action-btn btn-primary" onclick="window.UnifiedLeadManager.exportLeads()" 
                title="ייצא את הלידים המפולטרים לקובץ אקסל">
            📥 ייצא לאקסל
        </button>
    </div>
    
    <!-- Header moved to bottom to save mobile space -->
    <div class="lead-header" style="margin-top: 25px; margin-bottom: 0; border-bottom: none; border-top: 2px solid #e2e8f0; padding-top: 20px; padding-bottom: 15px;">
        <div class="lead-title">
            <span>📊</span>
            <span>לוח בקרה - ניהול לידים</span>
            <span id="customerName" style="font-size: 0.7em; color: #6b7280;"></span>
        </div>
    </div>
</div>

<!-- Lead Details Modal -->
<div id="leadModal" class="modal" style="display: none;">
    <div class="modal-content" style="width: 95%; max-width: 1000px; height: 95vh;">
        <div class="modal-header">
            <h2 id="leadModalTitle">פרטי ליד</h2>
            <span class="close" onclick="window.UnifiedLeadManager.closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="leadModalBody">
            <!-- Lead details will be populated here -->
        </div>
    </div>
</div>

<script>
// Unified Lead Manager - State of the Art Component
class UnifiedLeadManagerClass {
    constructor() {
        this.leads = [];
        this.filteredLeads = [];
        this.selectedLeads = new Set();
        this.currentCustomer = null;
        this.userRole = '{{ session.get("role") }}';
        this.username = '{{ session.get("username") }}';
        this.users = [];
        this.customers = [];
        this.campaigns = new Set();
        
        console.log('UnifiedLeadManager: Initializing for role:', this.userRole);
        this.init();
    }
    
    async init() {
        console.log('Initializing Unified Lead Manager for role:', this.userRole);
        
        // Setup role-based features
        if (this.userRole === 'admin') {
            document.getElementById('customerSelectorDiv').style.display = 'flex';
            await this.loadCustomers();
        }
        
        // Load initial data
        await this.loadUsers();
        await this.loadLeads();
        
        // Debug: Check if leads were loaded
        console.log('🔍 DEBUGGING: After loadLeads, this.leads.length:', this.leads.length);
        console.log('🔍 DEBUGGING: After loadLeads, this.filteredLeads.length:', this.filteredLeads.length);
        
        // Setup auto-refresh
        setInterval(() => this.refreshLeads(), 60000); // Refresh every minute
    }
    
    async loadCustomers() {
        try {
            const response = await fetch('/admin/customers/api');
            const customers = await response.json();
            this.customers = customers;
            
            const selector = document.getElementById('customerSelector');
            selector.innerHTML = '<option value="">כל הלקוחות</option>';
            customers.forEach(customer => {
                if (customer.active) {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = customer.name;
                    selector.appendChild(option);
                }
            });
            
            // Set current customer
            this.currentCustomer = '{{ session.get("selected_customer_id") }}' || null;
            if (this.currentCustomer) {
                selector.value = this.currentCustomer;
                const customer = customers.find(c => c.id == this.currentCustomer);
                if (customer) {
                    document.getElementById('customerName').textContent = `- ${customer.name}`;
                }
            }
        } catch (error) {
            console.error('Error loading customers:', error);
        }
    }
    
    async loadUsers() {
        try {
            const response = await fetch('/admin/users/api');
            const data = await response.json();
            this.users = data.users || [];
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }
    
    async loadLeads() {
        try {
            console.log('🔍 DEBUGGING: Starting loadLeads function...');
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            console.log('🔍 DEBUGGING: Fetching /leads endpoint...');
            const response = await fetch('/leads');
            console.log('🔍 DEBUGGING: Response status:', response.status);
            console.log('🔍 DEBUGGING: Response headers:', Object.fromEntries(response.headers.entries()));
            
            if (!response.ok) {
                console.error('🔍 DEBUGGING: Response not OK, status:', response.status);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            console.log('🔍 DEBUGGING: Parsing JSON response...');
            const data = await response.json();
            console.log('🔍 DEBUGGING: Raw API response:', JSON.stringify(data, null, 2));
            
            // Handle different response formats
            if (data.leads && Array.isArray(data.leads)) {
                this.leads = data.leads;
                console.log('🔍 DEBUGGING: Using data.leads array, length:', data.leads.length);
            } else if (Array.isArray(data)) {
                this.leads = data;
                console.log('🔍 DEBUGGING: Using data as array, length:', data.length);
            } else {
                console.warn('🔍 DEBUGGING: Unexpected data format:', data);
                console.warn('🔍 DEBUGGING: data.leads exists:', !!data.leads);
                console.warn('🔍 DEBUGGING: data is array:', Array.isArray(data));
                this.leads = [];
            }
            
            console.log('🔍 DEBUGGING: Final leads array length:', this.leads.length);
            console.log('🔍 DEBUGGING: First lead sample:', this.leads[0] || 'No leads');
            
            // Extract campaigns for filter
            this.campaigns.clear();
            this.leads.forEach(lead => {
                if (lead.campaign_name) {
                    this.campaigns.add(lead.campaign_name);
                }
            });
            
            // Update campaign filter
            const campaignFilter = document.getElementById('campaignFilter');
            campaignFilter.innerHTML = '<option value="">כל הקמפיינים</option>';
            Array.from(this.campaigns).sort().forEach(campaign => {
                const option = document.createElement('option');
                option.value = campaign;
                option.textContent = campaign.substring(0, 30) + (campaign.length > 30 ? '...' : '');
                campaignFilter.appendChild(option);
            });
            
            this.applyFilters();
            
        } catch (error) {
            console.error('Error loading leads:', error);
            this.showToast(`שגיאה בטעינת הלידים: ${error.message}`, 'error');
            this.leads = [];
            this.applyFilters();
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }
    
    filterLeadsByType(type) {
        console.log('🔍 DEBUGGING: filterLeadsByType called with type:', type);
        
        // Update active chip
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.classList.remove('active');
        });
        document.querySelector(`[data-filter="${type}"]`).classList.add('active');
        
        // Update status filter dropdown to match
        const statusFilter = document.getElementById('statusFilter');
        if (type === 'all') {
            statusFilter.value = '';
        } else if (type === 'unassigned') {
            statusFilter.value = '';
            // We'll handle unassigned filtering separately
        } else {
            statusFilter.value = type;
        }
        
        // Apply the filter
        this.applyFilters();
    }
    
    getFilterLabel(type) {
        const labels = {
            'all': 'כל הלידים',
            'new': 'חדשים',
            'contacted': 'נוצר קשר',
            'qualified': 'מוכשרים',
            'interested': 'מתעניינים',
            'hired': 'התקבלו',
            'rejected': 'נדחו',
            'closed': 'סגורים',
            'unassigned': 'לא מוקצים'
        };
        return labels[type] || type;
    }

    applyFilters() {
        console.log('🔍 DEBUGGING: applyFilters called');
        console.log('🔍 DEBUGGING: Total leads before filtering:', this.leads.length);
        
        const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const assignmentFilter = document.getElementById('assignmentFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;
        const campaignFilter = document.getElementById('campaignFilter').value;
        
        // Check if we're filtering by unassigned from chips
        const activeChip = document.querySelector('.filter-chip.active');
        const isUnassignedFilter = activeChip && activeChip.dataset.filter === 'unassigned';
        
        console.log('🔍 DEBUGGING: Filter values:', {
            searchTerm, statusFilter, assignmentFilter, dateFilter, campaignFilter, isUnassignedFilter
        });
        
        this.filteredLeads = this.leads.filter(lead => {
            // Search filter
            if (searchTerm) {
                const searchableText = `${lead.name} ${lead.phone} ${lead.email} ${lead.campaign_name}`.toLowerCase();
                if (!searchableText.includes(searchTerm)) return false;
            }
            
            // Status filter
            if (statusFilter) {
                if (statusFilter === 'not_closed') {
                    // לא סגור - exclude only 'closed' status
                    if (lead.status === 'closed') return false;
                } else if (lead.status !== statusFilter) {
                    return false;
                }
            }
            
            // Assignment filter
            if (assignmentFilter) {
                if (assignmentFilter === 'unassigned' && lead.assigned_to) return false;
                if (assignmentFilter === 'assigned' && !lead.assigned_to) return false;
                if (assignmentFilter === 'mine' && lead.assigned_to !== this.username) return false;
            }
            
            // Handle unassigned filter from chips
            if (isUnassignedFilter) {
                const isNotAssigned = !lead.assigned_to || lead.assigned_to === '' || lead.assigned_to === null;
                const isNotClosed = lead.status !== 'closed';
                if (!isNotAssigned || !isNotClosed) return false;
            }
            
            // Date filter
            if (dateFilter) {
                const leadDate = new Date(lead.created_time || lead.received_at);
                const now = new Date();
                
                if (dateFilter === 'today') {
                    if (leadDate.toDateString() !== now.toDateString()) return false;
                } else if (dateFilter === 'week') {
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    if (leadDate < weekAgo) return false;
                } else if (dateFilter === 'month') {
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    if (leadDate < monthAgo) return false;
                }
            }
            
            // Campaign filter
            if (campaignFilter && lead.campaign_name !== campaignFilter) return false;
            
            return true;
        });
        
        console.log('🔍 DEBUGGING: Filtered leads count:', this.filteredLeads.length);
        console.log('🔍 DEBUGGING: Sample filtered lead:', this.filteredLeads[0] || 'No filtered leads');
        
        this.renderLeads();
    }
    
    renderLeads() {
        const tbody = document.getElementById('leadsTableBody');
        const cardsContainer = document.getElementById('leadCardsContainer');
        const emptyState = document.getElementById('emptyState');
        
        if (this.filteredLeads.length === 0) {
            tbody.innerHTML = '';
            cardsContainer.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }
        
        emptyState.style.display = 'none';
        
        // Render table for desktop
        tbody.innerHTML = this.filteredLeads.map(lead => {
            const priority = this.calculatePriority(lead);
            const priorityClass = priority >= 70 ? 'priority-high' : priority >= 40 ? 'priority-medium' : 'priority-low';
            const priorityIcon = priority >= 70 ? '🔥' : priority >= 40 ? '⚡' : '🔵';
            
            return `
                <tr data-lead-id="${lead.id}">
                    <td>
                        <input type="checkbox" class="lead-checkbox" value="${lead.id}" 
                               onchange="UnifiedLeadManager.toggleLead(${lead.id}, this.checked)"
                               title="בחר את הליד ${lead.name || 'זה'} לביצוע פעולות קבוצתיות">
                    </td>
                    <td>
                        <button class="action-btn btn-primary" onclick="window.UnifiedLeadManager.viewLead(${lead.id})" 
                                title="הצג פרטים מלאים ופעילויות של ${lead.name || 'הליד'}">👁️</button>
                        ${lead.phone ? `
                            <a href="tel:${lead.phone}" class="action-btn btn-call" 
                               title="התקשר ל-${lead.name || 'ליד'} בטלפון ${lead.phone}">📞</a>
                            <a href="https://wa.me/${this.formatPhoneForWhatsApp(lead.phone)}" 
                               target="_blank" class="action-btn btn-whatsapp" 
                               title="שלח הודעת WhatsApp ל-${lead.name || 'ליד'} (${lead.phone})">💬</a>
                        ` : ''}
                        ${lead.email ? `
                            <a href="mailto:${lead.email}" class="action-btn btn-email" 
                               title="שלח אימייל ל-${lead.name || 'ליד'} בכתובת ${lead.email}">✉️</a>
                        ` : ''}
                        ${this.canAssign() ? `
                            <button class="action-btn btn-assign" onclick="window.UnifiedLeadManager.quickAssign(${lead.id})" 
                                    title="הקצה את הליד ${lead.name || 'זה'} למשתמש אחר">👤</button>
                        ` : ''}
                        ${this.userRole === 'admin' ? `
                            <button class="action-btn btn-delete" onclick="window.UnifiedLeadManager.deleteLead(${lead.id})" 
                                    title="מחק את הליד ${lead.name || 'זה'} לצמיתות (מנהל בלבד)">🗑️</button>
                        ` : ''}
                    </td>
                    <td>
                        <span class="status-badge status-${lead.status}" 
                              onclick="window.UnifiedLeadManager.quickStatusChange(${lead.id})"
                              title="לחץ לשינוי סטטוס">
                            ${this.getStatusLabel(lead.status)}
                        </span>
                    </td>
                    <td><strong>${lead.name || 'לא צוין'}</strong></td>
                    <td title="${lead.campaign_name || ''}">${(lead.campaign_name || '-').substring(0, 30)}</td>
                    <td>${lead.assigned_full_name || lead.assigned_to || 'לא מוקצה'}</td>
                    <td>${this.formatDate(lead.created_time || lead.received_at)}</td>
                </tr>
            `;
        }).join('');
        
        // Render cards for mobile
        cardsContainer.innerHTML = this.filteredLeads.map(lead => {
            const priority = this.calculatePriority(lead);
            const priorityClass = priority >= 70 ? 'priority-high' : priority >= 40 ? 'priority-medium' : 'priority-low';
            const priorityIcon = priority >= 70 ? '🔥' : priority >= 40 ? '⚡' : '🔵';
            
            return `
                <div class="lead-card status-${lead.status}" data-lead-id="${lead.id}">
                    <div class="lead-card-header">
                        <div>
                            <div class="lead-card-name">${lead.name || 'לא צוין'}</div>
                        </div>
                        <div class="lead-card-status">
                            <span class="status-badge status-${lead.status}"
                                  onclick="event.stopPropagation(); console.log('🔍 DEBUGGING: Mobile status badge clicked for lead:', ${lead.id}); window.UnifiedLeadManager.quickStatusChange(${lead.id})"
                                  title="לחץ לשינוי סטטוס"
                                  style="position: relative;">
                                ${this.getStatusLabel(lead.status)}
                                <span style="position: absolute; top: -5px; right: -5px; font-size: 12px; color: #059669;">✏️</span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="lead-card-info">
                        <div style="font-size: 16px; margin-bottom: 8px;"><strong>קמפיין:</strong> ${(lead.campaign_name || 'לא צוין').substring(0, 40)}</div>
                        <div style="display: flex; justify-content: space-between;">
                            <div><strong>תאריך:</strong> ${this.formatDate(lead.created_time || lead.received_at)}</div>
                        </div>
                        <div style="margin-top: 8px;"><strong>מוקצה ל:</strong> ${lead.assigned_to || 'לא מוקצה'}</div>
                    </div>
                    
                    <div class="lead-card-actions">
                        <button class="action-btn btn-primary" onclick="event.stopPropagation(); window.UnifiedLeadManager.viewLead(${lead.id})" 
                                title="צפה בפרטים המלאים של ${lead.name || 'הליד'}">👁️</button>
                        ${lead.phone ? `
                            <a href="tel:${lead.phone}" class="action-btn btn-call" 
                               title="התקשר ל-${lead.name || 'ליד'}: ${lead.phone}">📞</a>
                            <a href="https://wa.me/${this.formatPhoneForWhatsApp(lead.phone)}" 
                               target="_blank" class="action-btn btn-whatsapp" 
                               title="פתח WhatsApp עם ${lead.name || 'ליד'}: ${lead.phone}">💬</a>
                        ` : ''}
                        ${lead.email ? `
                            <a href="mailto:${lead.email}" class="action-btn btn-email" 
                               title="שלח אימייל ל-${lead.name || 'ליד'}: ${lead.email}">✉️</a>
                        ` : ''}
                        ${this.canAssign() ? `
                            <button class="action-btn btn-assign" onclick="event.stopPropagation(); window.UnifiedLeadManager.quickAssign(${lead.id})" 
                                    title="הקצה את ${lead.name || 'הליד'} למשתמש אחר">👤</button>
                        ` : ''}
                        ${this.userRole === 'admin' ? `
                            <button class="action-btn btn-delete" onclick="event.stopPropagation(); window.UnifiedLeadManager.deleteLead(${lead.id})" 
                                    title="מחק את ${lead.name || 'הליד'} לצמיתות (מנהל בלבד)">🗑️</button>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    calculatePriority(lead) {
        let score = 0;
        
        // New lead bonus
        if (lead.status === 'new') score += 30;
        
        // Contact info completeness
        if (lead.phone) score += 20;
        if (lead.email) score += 10;
        
        // Time decay (newer = higher priority)
        const ageInDays = (Date.now() - new Date(lead.created_time || lead.received_at)) / (1000 * 60 * 60 * 24);
        if (ageInDays <= 1) score += 30;
        else if (ageInDays <= 3) score += 20;
        else if (ageInDays <= 7) score += 10;
        
        // Not assigned bonus
        if (!lead.assigned_to) score += 10;
        
        return Math.min(100, score);
    }
    
    canAssign() {
        return this.userRole === 'admin' || this.userRole === 'campaign_manager';
    }
    
    getStatusLabel(status) {
        const labels = {
            'new': 'חדש',
            'contacted': 'נוצר קשר',
            'qualified': 'מוכשר',
            'interested': 'מתעניין',
            'not_interested': 'לא מתעניין',
            'callback': 'חזרה',
            'interview_scheduled': 'מתואם ראיון',
            'hired': 'התקבל',
            'rejected': 'נדחה',
            'closed': 'סגור'
        };
        return labels[status] || status;
    }
    
    formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString('he-IL');
    }
    
    formatPhoneForWhatsApp(phone) {
        if (!phone) return '';
        
        // Remove all non-digit characters
        let cleanPhone = phone.replace(/[^0-9]/g, '');
        
        // Handle Israeli phone numbers
        if (cleanPhone.startsWith('972')) {
            // Already has country code
            return cleanPhone;
        } else if (cleanPhone.startsWith('0')) {
            // Remove leading 0 and add Israel country code
            return '972' + cleanPhone.substring(1);
        } else if (cleanPhone.length === 9) {
            // 9 digits without leading 0, add country code
            return '972' + cleanPhone;
        } else if (cleanPhone.length === 10 && cleanPhone.startsWith('0')) {
            // 10 digits with leading 0
            return '972' + cleanPhone.substring(1);
        } else {
            // Default: assume it needs Israel country code
            return '972' + cleanPhone;
        }
    }
    
    updateStats() {
        // Stats removed from UI - no longer needed
    }
    
    async viewLead(leadId) {
        const lead = this.leads.find(l => l.id === leadId);
        if (!lead) return;
        
        try {
            const response = await fetch(`/leads/${leadId}`);
            const data = await response.json();
            
            if (data.lead) {
                this.showLeadModal(data.lead, data.activities || []);
            }
        } catch (error) {
            console.error('Error loading lead details:', error);
        }
    }
    
    showLeadModal(lead, activities) {
        const modal = document.getElementById('leadModal');
        const modalBody = document.getElementById('leadModalBody');
        const modalTitle = document.getElementById('leadModalTitle');
        
        modalTitle.textContent = `פרטי ליד #${lead.id} - ${lead.name || 'לא צוין'}`;
        
        // Parse raw data for Zapier information
        let rawData = {};
        try {
            rawData = lead.raw_data ? (typeof lead.raw_data === 'string' ? JSON.parse(lead.raw_data) : lead.raw_data) : {};
        } catch (e) {
            console.error('Error parsing raw data:', e);
        }
        
        // Extract Facebook lead form info
        const leadFormId = rawData['מזהה טופס לידים'] || rawData.lead_form_id || rawData.form_id;
        const facebookPageId = rawData.page_id || rawData.facebook_page_id;
        const leadId = lead.external_lead_id;
        
        modalBody.innerHTML = `
            <!-- Basic Lead Information -->
            <div style="background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="margin-bottom: 15px; color: #1e293b;">👤 פרטי הליד #${lead.id}</h3>
                        <div style="display: grid; gap: 12px;">
                            <div><strong>מספר ליד:</strong> #${lead.id}</div>
                            <div><strong>שם מלא:</strong> ${lead.name || 'לא צוין'}</div>
                            <div><strong>טלפון:</strong> ${lead.phone ? `<a href="tel:${lead.phone}" style="color: #059669;">${lead.phone}</a>` : 'לא צוין'}</div>
                            <div><strong>אימייל:</strong> ${lead.email ? `<a href="mailto:${lead.email}" style="color: #059669;">${lead.email}</a>` : 'לא צוין'}</div>

                            <!-- Facebook Lead Management Links -->
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);">
                                <div style="margin-bottom: 8px;"><strong>ניהול הליד בפייסבוק:</strong></div>

                                ${leadFormId ? `
                                    <div style="margin-bottom: 8px;">
                                        <a href="https://business.facebook.com/latest/lead_access/leads?form_id=${leadFormId}" target="_blank" style="color: #1877f2;">
                                            📋 טופס לידים: ${leadFormId}
                                        </a>
                                    </div>
                                ` : ''}

                                ${facebookPageId && leadId ? `
                                    <div style="margin-bottom: 8px;">
                                        <a href="https://business.facebook.com/latest/lead_access/leads?page_id=${facebookPageId}&lead_id=${leadId}" target="_blank" style="color: #1877f2;">
                                            🎯 הליד הספציפי בפייסבוק
                                        </a>
                                    </div>
                                ` : ''}

                                ${lead.platform === 'fb' || lead.platform === 'ig' ? `
                                    <div style="margin-bottom: 8px;">
                                        <a href="https://business.facebook.com/latest/lead_access/leads" target="_blank" style="color: #4267B2;">
                                            📊 כל הלידים ב-Meta Business
                                        </a>
                                    </div>
                                    <div style="margin-bottom: 8px;">
                                        <a href="https://business.facebook.com/latest/inbox" target="_blank" style="color: #4267B2;">
                                            💬 הודעות Meta Business Suite
                                        </a>
                                    </div>
                                ` : ''}

                                ${lead.external_lead_id ? `
                                    <div style="margin-bottom: 8px;">
                                        <strong>מזהה ליד:</strong> <code style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 12px;">${lead.external_lead_id}</code>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 15px; color: #1e293b;">📊 מצב הליד</h3>
                        <div style="display: grid; gap: 12px;">
                            <div><strong>סטטוס נוכחי:</strong> <span class="status-badge status-${lead.status}" style="margin-right: 8px;">${this.getStatusLabel(lead.status)}</span></div>
                            <div><strong>מוקצה ל:</strong> ${lead.assigned_to || 'לא מוקצה'}</div>
                            <div><strong>תאריך קבלה:</strong> ${this.formatDate(lead.created_time || lead.received_at)}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Zapier Data Display -->
            ${Object.keys(rawData).length > 0 ? `
                <!-- Campaign & Ad Information -->
                <div style="background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #0ea5e9; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);">
                    <h3 style="color: #0c4a6e; margin: 0 0 20px 0; font-size: 1.4em;">📊 פרטי קמפיין ומודעות</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div style="margin-bottom: 12px;"><strong>מזהה מודעה:</strong> ${rawData['Ad Id'] || 'לא צוין'}</div>
                            <div style="margin-bottom: 12px;"><strong>שם המודעה:</strong> ${rawData['Ad Name'] || 'לא צוין'}</div>
                            <div style="margin-bottom: 12px;"><strong>מזהה קבוצת מודעות:</strong> ${rawData['Adset Id'] || 'לא צוין'}</div>
                            <div style="margin-bottom: 12px;"><strong>שם קבוצת מודעות:</strong> ${rawData['Adset Name'] || 'לא צוין'}</div>
                        </div>
                        <div>
                            <div style="margin-bottom: 12px;"><strong>מזהה קמפיין:</strong> ${rawData['Campaign Id'] || 'לא צוין'}</div>
                            <div style="margin-bottom: 12px;"><strong>שם קמפיין:</strong> ${rawData['Campaign Name'] || 'לא צוין'}</div>
                            <div style="margin-bottom: 12px;"><strong>זמן יצירה:</strong> ${rawData['Created Time'] ? new Date(rawData['Created Time']).toLocaleString('he-IL') : 'לא צוין'}</div>
                            <div style="margin-bottom: 12px;"><strong>פלטפורמה:</strong> ${rawData['Platform'] || 'לא צוין'}</div>
                        </div>
                    </div>
                </div>

                <!-- Form & Page Information -->
                <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #22c55e; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15);">
                    <h3 style="color: #166534; margin: 0 0 20px 0; font-size: 1.4em;">📋 פרטי טופס ועמוד</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div style="margin-bottom: 12px;"><strong>מזהה טופס:</strong> ${rawData['Form Id'] || 'לא צוין'}</div>
                            <div style="margin-bottom: 12px;"><strong>שם הטופס:</strong> ${rawData['Form Name'] || 'לא צוין'}</div>
                            <div style="margin-bottom: 12px;"><strong>מזהה ליד:</strong> ${rawData['Lead Id'] || 'לא צוין'}</div>
                        </div>
                        <div>
                            <div style="margin-bottom: 12px;"><strong>מזהה עמוד:</strong> ${rawData['Page Id'] || 'לא צוין'}</div>
                            <div style="margin-bottom: 12px;"><strong>שם עמוד:</strong> ${rawData['Page Name'] || 'לא צוין'}</div>
                            <div style="margin-bottom: 12px;"><strong>תגובות הצהרת סירוב:</strong> ${rawData['Custom Disclaimer Responses'] || 'לא צוין'}</div>
                        </div>
                    </div>
                </div>

                <!-- Form Responses -->
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);">
                    <h3 style="color: #92400e; margin: 0 0 20px 0; font-size: 1.4em;">✍️ תשובות הטופס</h3>
                    <div style="display: grid; gap: 16px;">
                        ${(() => {
                            // Filter out system fields and show form responses
                            const systemFields = ['Ad Id', 'Ad Name', 'Adset Id', 'Adset Name', 'Campaign Id', 'Campaign Name', 
                                                'Created Time', 'Form Id', 'Lead Id', 'Platform', 'Page Id', 'Page Name', 
                                                'Form Name', 'Custom Disclaimer Responses', 'Partner Name', 'Retailer Item Id', 'Vehicle',
                                                'id', 'name', 'email', 'phone', 'platform', 'created_time', 'received_at', 'status', 'assigned_to', 'priority', 'notes', 'updated_at'];
                            
                            return Object.entries(rawData)
                            .filter(([key, value]) => {
                                return value != null && value !== '' && value !== 'null' && !systemFields.includes(key);
                            })
                            .map(([key, value]) => {
                                let displayValue = value;
                                if (typeof value === 'object') {
                                    displayValue = JSON.stringify(value, null, 2);
                                }
                                
                                return `
                                    <div style="padding: 15px; background: rgba(255,255,255,0.8); border-radius: 8px; border: 1px solid #fbbf24;">
                                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 16px;">
                                            ${key}
                                        </div>
                                        <div style="color: #4b5563; font-size: 14px; line-height: 1.5; white-space: pre-wrap;">
                                            ${displayValue}
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        })()}
                    </div>
                </div>

                <!-- Additional Fields -->
                ${rawData['Partner Name'] || rawData['Retailer Item Id'] || rawData['Vehicle'] ? `
                    <div style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #a855f7; box-shadow: 0 4px 12px rgba(168, 85, 247, 0.15);">
                        <h3 style="color: #6b21a8; margin: 0 0 20px 0; font-size: 1.4em;">🔧 שדות נוספים</h3>
                        <div style="display: grid; gap: 12px;">
                            ${rawData['Partner Name'] ? `<div><strong>שם שותף:</strong> ${rawData['Partner Name']}</div>` : ''}
                            ${rawData['Retailer Item Id'] ? `<div><strong>מזהה פריט קמעונאי:</strong> ${rawData['Retailer Item Id']}</div>` : ''}
                            ${rawData['Vehicle'] ? `<div><strong>רכב:</strong> ${rawData['Vehicle']}</div>` : ''}
                        </div>
                    </div>
                ` : ''}
            ` : '<div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; color: #6b7280;">אין נתונים מהטופס</div>'}

            <!-- Campaign & Source Information Button -->
            <div style="margin-bottom: 20px;">
                <button onclick="toggleCampaignInfo()" style="width: 100%; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; padding: 15px 20px; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: 600; color: #1e293b; transition: all 0.2s ease;">
                    🎯 מקור הליד ומיקוד <span id="campaignToggleIcon" style="float: left;">▼</span>
                </button>
                <div id="campaignInfo" style="display: none; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 0 0 12px 12px; border: 2px solid #f59e0b; border-top: none; margin-top: -2px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <div style="margin-bottom: 10px;"><strong>פלטפורמה:</strong> ${lead.platform === 'fb' ? 'Facebook' : lead.platform === 'ig' ? 'Instagram' : lead.platform || 'לא צוין'}</div>
                            <div style="margin-bottom: 10px;"><strong>שם קמפיין:</strong> ${lead.campaign_name || 'לא צוין'}</div>
                            <div><strong>שם הטופס:</strong> ${lead.form_name || 'לא צוין'}</div>
                        </div>
                        <div>
                            <div style="margin-bottom: 10px;"><strong>מקור ליד:</strong> ${lead.lead_source || 'לא צוין'}</div>
                            <div style="margin-bottom: 10px;"><strong>ID חיצוני:</strong> ${lead.external_lead_id || 'לא צוין'}</div>
                            <div><strong>עדיפות:</strong> ${lead.priority || 'רגילה'}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes Section -->
            ${lead.notes ? `
                <div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #1e293b;">📝 הערות</h3>
                    <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 8px;">
                        ${lead.notes}
                    </div>
                </div>
            ` : ''}
            
            <!-- Activity History -->
            <div style="background: #f8fafc; padding: 20px; border-radius: 12px;">
                <h3 style="margin-bottom: 15px; color: #1e293b;">📈 היסטוריית פעילות</h3>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${activities.length > 0 ? activities.map(activity => `
                        <div style="padding: 15px; background: linear-gradient(135deg, #fef7cd 0%, #fef3c7 100%); border-radius: 8px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span style="background: #059669; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600;">
                                    ${this.getActivityLabel(activity.activity_type)}
                                </span>
                                <span style="color: #6b7280; font-size: 0.9em;">${this.formatDate(activity.created_at)}</span>
                            </div>
                            <div style="color: #374151;">${activity.description || 'אין תיאור'}</div>
                            ${activity.user_name ? `<div style="color: #6b7280; font-size: 0.85em; margin-top: 4px;">על ידי: ${activity.user_name}</div>` : ''}
                        </div>
                    `).join('') : '<div style="text-align: center; color: #6b7280; font-style: italic; padding: 40px;">אין פעילויות רשומות עדיין</div>'}
                </div>
            </div>
        `;
        
        modal.style.display = 'block';
    }
    
    getActivityLabel(type) {
        const labels = {
            'lead_received': 'ליד התקבל',
            'status_change': 'שינוי סטטוס',
            'assignment': 'הקצאה',
            'call': 'שיחה',
            'note_added': 'הערה'
        };
        return labels[type] || type;
    }
    
    closeModal() {
        document.getElementById('leadModal').style.display = 'none';
    }
    
    async quickAssign(leadId) {
        // Implementation for quick assignment
        const lead = this.leads.find(l => l.id === leadId);
        if (!lead) return;
        
        try {
            // Load available users for assignment (filtered by customer for campaign managers)
            console.log('🔍 DEBUGGING: Loading users for assignment...');
            console.log('🔍 DEBUGGING: User role:', this.userRole);
            
            let usersApiUrl = '/admin/users/api';
            if (this.userRole === 'campaign_manager' && this.currentCustomer) {
                usersApiUrl += `?customer_id=${this.currentCustomer}`;
            }
            
            console.log('🔍 DEBUGGING: Fetching users from:', usersApiUrl);
            const response = await fetch(usersApiUrl);
            console.log('🔍 DEBUGGING: Users API response status:', response.status);
            
            if (!response.ok) {
                console.error('🔍 DEBUGGING: Users API failed with status:', response.status);
                throw new Error(`Failed to load users (HTTP ${response.status})`);
            }
            
            const usersData = await response.json();
            console.log('🔍 DEBUGGING: Users API response:', usersData);
            
            // Handle different response formats from the users API
            let users;
            if (usersData.users && Array.isArray(usersData.users)) {
                users = usersData.users;
            } else if (Array.isArray(usersData)) {
                users = usersData;
            } else {
                console.error('🔍 DEBUGGING: Unexpected users data format:', usersData);
                throw new Error('Invalid users data format');
            }
            
            // Create assignment modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>הקצאת ליד: ${lead.name || 'לא צוין'}</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">✖️</button>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 15px;">בחר משתמש להקצאת הליד:</p>
                        <select id="assignUserSelect" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px;">
                            <option value="">בחר משתמש...</option>
                            <option value="">ביטול הקצאה (לא מוקצה)</option>
                            ${users.map(user => `
                                <option value="${user.username}" ${lead.assigned_to === user.username ? 'selected' : ''}>
                                    ${user.full_name} (${user.username})
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button class="action-btn btn-primary" onclick="window.UnifiedLeadManager.performAssignment(${leadId}, document.getElementById('assignUserSelect').value, this.closest('.modal-overlay'))">
                            הקצה
                        </button>
                        <button class="action-btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                            ביטול
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
        } catch (error) {
            console.error('Error loading users for assignment:', error);
            this.showToast('שגיאה בטעינת רשימת המשתמשים', 'error');
        }
    }
    
    async performAssignment(leadId, assignedTo, modal) {
        try {
            const response = await fetch(`/leads/${leadId}/assign`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ assigned_to: assignedTo })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                this.showToast(result.message || 'הליד הוקצה בהצלחה', 'success');
                await this.loadLeads();
                modal.remove();
            } else {
                this.showToast(result.error || 'שגיאה בהקצאת הליד', 'error');
            }
        } catch (error) {
            console.error('Assignment error:', error);
            this.showToast('שגיאה בהקצאת הליד', 'error');
        }
    }
    
    async quickStatusChange(leadId) {
        console.log('🔍 DEBUGGING: quickStatusChange called for leadId:', leadId);
        const lead = this.leads.find(l => l.id === leadId);
        if (!lead) {
            console.error('🔍 DEBUGGING: Lead not found for ID:', leadId);
            return;
        }
        
        console.log('🔍 DEBUGGING: Found lead:', lead);
        
        // Use the same modal system that works on PC - showStatusChangeWithNote
        // This ensures mobile gets the same working interface as PC
        this.showStatusChangeWithNote(leadId, lead.status, null);
    }
    
    showMobileStatusFallback(leadId, lead) {
        // Simple fallback using prompt for mobile
        const statusOptions = [
            { value: 'new', label: 'חדש' },
            { value: 'contacted', label: 'נוצר קשר' },
            { value: 'qualified', label: 'מוכשר' },
            { value: 'interested', label: 'מתעניין' },
            { value: 'hired', label: 'התקבל' },
            { value: 'rejected', label: 'נדחה' },
            { value: 'closed', label: 'סגור' }
        ];
        
        const statusList = statusOptions.map((status, index) => 
            `${index + 1}. ${status.label}`
        ).join('\n');
        
        const userInput = prompt(
            `עדכון סטטוס לליד: ${lead.name || 'ליד'}\n\n` +
            `סטטוס נוכחי: ${this.getStatusLabel(lead.status)}\n\n` +
            `בחר סטטוס חדש:\n${statusList}\n\n` +
            `הזן מספר (1-7):`
        );
        
        if (userInput && !isNaN(userInput)) {
            const selectedIndex = parseInt(userInput) - 1;
            if (selectedIndex >= 0 && selectedIndex < statusOptions.length) {
                const selectedStatus = statusOptions[selectedIndex];
                const note = prompt(`הוסף הערה על העדכון ל"${selectedStatus.label}":`);
                if (note !== null) {
                    this.performStatusChangeWithNote(leadId, selectedStatus.value, note, null);
                }
            }
        }
    }
    
    showStatusChangeWithNote(leadId, newStatus, currentModal) {
        // Close current modal if exists
        if (currentModal) currentModal.remove();

        const lead = this.leads.find(l => l.id === leadId);
        if (!lead) return;

        // Create status selection modal (same as PC version)
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.zIndex = '10001';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>עדכון סטטוס: ${lead.name || 'ליד'}</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">✖️</button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 20px; text-align: center;">
                        <p style="color: #6b7280; margin-bottom: 8px;">סטטוס נוכחי:</p>
                        <span class="status-badge status-${lead.status}" style="pointer-events: none;">${this.getStatusLabel(lead.status)}</span>
                    </div>
                    
                    <div class="mobile-status-grid">
                        <button class="mobile-status-btn status-new" onclick="window.UnifiedLeadManager.showStatusNoteModal(${leadId}, 'new', this.closest('.modal-overlay'))">
                            <div class="status-icon">🆕</div>
                            <div>חדש</div>
                        </button>
                        <button class="mobile-status-btn status-contacted" onclick="window.UnifiedLeadManager.showStatusNoteModal(${leadId}, 'contacted', this.closest('.modal-overlay'))">
                            <div class="status-icon">📞</div>
                            <div>נוצר קשר</div>
                        </button>
                        <button class="mobile-status-btn status-qualified" onclick="window.UnifiedLeadManager.showStatusNoteModal(${leadId}, 'qualified', this.closest('.modal-overlay'))">
                            <div class="status-icon">✅</div>
                            <div>מוכשר</div>
                        </button>
                        <button class="mobile-status-btn status-interested" onclick="window.UnifiedLeadManager.showStatusNoteModal(${leadId}, 'interested', this.closest('.modal-overlay'))">
                            <div class="status-icon">🎯</div>
                            <div>מתעניין</div>
                        </button>
                        <button class="mobile-status-btn status-hired" onclick="window.UnifiedLeadManager.showStatusNoteModal(${leadId}, 'hired', this.closest('.modal-overlay'))">
                            <div class="status-icon">🎉</div>
                            <div>התקבל</div>
                        </button>
                        <button class="mobile-status-btn status-rejected" onclick="window.UnifiedLeadManager.showStatusNoteModal(${leadId}, 'rejected', this.closest('.modal-overlay'))">
                            <div class="status-icon">❌</div>
                            <div>נדחה</div>
                        </button>
                    </div>

                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <button class="mobile-status-btn" style="width: 100%; border-color: #ef4444; color: #ef4444;"
                                onclick="window.UnifiedLeadManager.showStatusNoteModal(${leadId}, 'closed', this.closest('.modal-overlay'))">
                            <div class="status-icon">🔒</div>
                            <div>סגור ליד לצמיתות</div>
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    showStatusNoteModal(leadId, newStatus, currentModal) {
        // Close current modal if exists
        if (currentModal) currentModal.remove();

        const lead = this.leads.find(l => l.id === leadId);
        if (!lead) return;

        // Create note input modal for status change
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.zIndex = '10001';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>עדכון סטטוס ל: ${this.getStatusLabel(newStatus)}</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">✖️</button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 15px;">
                        <p style="color: #6b7280; margin-bottom: 8px;">שם הליד: <strong>${lead.name || 'ליד'}</strong></p>
                        <p style="color: #6b7280; margin-bottom: 12px;">סטטוס נוכחי: <span class="status-badge status-${lead.status}">${this.getStatusLabel(lead.status)}</span></p>
                        <p style="color: #059669; margin-bottom: 16px;">סטטוס חדש: <span class="status-badge status-${newStatus}">${this.getStatusLabel(newStatus)}</span></p>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #dc2626;">הערת עדכון (חובה):</label>
                        <textarea id="statusNoteModal${leadId}" placeholder="הוסף הערה על העדכון (שדה חובה)..."
                                style="width: 100%; padding: 10px; border: 2px solid #dc2626; border-radius: 8px; height: 100px; resize: vertical;"
                                autofocus required></textarea>
                        <small style="color: #dc2626; font-size: 12px; margin-top: 4px; display: block;">* שדה חובה - יש להזין הערה לפני עדכון הסטטוס</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="action-btn btn-primary" onclick="window.UnifiedLeadManager.performStatusChangeWithNote(${leadId}, '${newStatus}', document.getElementById('statusNoteModal${leadId}').value, this.closest('.modal-overlay'))">
                        עדכן סטטוס
                    </button>
                    <button class="action-btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                        ביטול
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Focus on the note field
        setTimeout(() => {
            const noteField = document.getElementById(`statusNoteModal${leadId}`);
            if (noteField) noteField.focus();
        }, 100);
    }

    async closeLeadDirectly(leadId) {
        // Redirect to note modal for closure
        this.showStatusChangeWithNote(leadId, 'closed', null);
    }
    
    async performStatusChangeWithNote(leadId, newStatus, note, modal) {
        // Enhanced status change with mandatory note

        // Validate note is provided
        if (!note || !note.trim()) {
            this.showToast('יש להזין הערה לפני עדכון הסטטוס', 'error');
            // Highlight the note field
            const noteField = document.getElementById('statusNote');
            if (noteField) {
                noteField.style.borderColor = '#dc2626';
                noteField.style.borderWidth = '3px';
                noteField.focus();
            }
            return;
        }

        try {
            const response = await fetch(`/leads/${leadId}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    status: newStatus,
                    user_name: this.fullName || this.username || 'משתמש',
                    note: note && note.trim() ? note.trim() : null
                })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                const statusLabel = this.getStatusLabel(newStatus);
                this.showToast(`סטטוס עודכן ל"${statusLabel}" עם הערה: "${note.trim()}"`, 'success');
                await this.loadLeads();
                if (modal) modal.remove();
            } else {
                this.showToast(result.error || 'שגיאה בעדכון סטטוס הליד', 'error');
            }
        } catch (error) {
            console.error('Status change with note error:', error);
            this.showToast('שגיאה בעדכון סטטוס הליד', 'error');
        }
    }

    async performStatusChange(leadId, newStatus, modal) {
        // Redirect to note modal - notes are now mandatory
        if (modal) modal.remove();
        this.showStatusChangeWithNote(leadId, newStatus, null);
    }
    
    async changeCustomer(customerId) {
        // Admin only - change selected customer
        try {
            const response = await fetch('/admin/select-customer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ customer_id: customerId })
            });
            
            if (response.ok) {
                this.currentCustomer = customerId;
                await this.loadLeads();
                
                const customer = this.customers.find(c => c.id == customerId);
                document.getElementById('customerName').textContent = customer ? `- ${customer.name}` : '';
            }
        } catch (error) {
            console.error('Error changing customer:', error);
        }
    }
    
    toggleSelectAll(checked) {
        const checkboxes = document.querySelectorAll('.lead-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = checked;
            const leadId = parseInt(cb.value);
            if (checked) {
                this.selectedLeads.add(leadId);
            } else {
                this.selectedLeads.delete(leadId);
            }
        });
    }
    
    toggleLead(leadId, checked) {
        if (checked) {
            this.selectedLeads.add(leadId);
        } else {
            this.selectedLeads.delete(leadId);
        }
    }
    
    async refreshLeads() {
        await this.loadLeads();
        this.showToast('הרשימה עודכנה', 'success');
    }
    
    async refreshAndApplyFilters() {
        // Refresh leads from server and then apply filters
        await this.loadLeads();
    }
    
    exportLeads() {
        // Implementation for export to Excel
        this.showToast('הייצוא לאקסל יתחיל בקרוב', 'info');
    }
    
    async deleteLead(leadId) {
        // Admin only - delete lead permanently
        if (this.userRole !== 'admin') {
            this.showToast('אין לך הרשאה למחוק לידים', 'error');
            return;
        }
        
        const lead = this.leads.find(l => l.id === leadId);
        const leadName = lead ? (lead.name || `ליד ${leadId}`) : `ליד ${leadId}`;
        
        // Confirmation dialog
        if (!confirm(`האם אתה בטוח שברצונך למחוק את הליד "${leadName}" לצמיתות?\n\nפעולה זו לא ניתנת לביטול!`)) {
            return;
        }
        
        try {
            const response = await fetch(`/admin/leads/delete/${leadId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const result = await response.json();
            
            if (response.ok) {
                this.showToast(`ליד "${leadName}" נמחק בהצלחה`, 'success');
                await this.loadLeads(); // Refresh the leads list
            } else {
                this.showToast(result.error || 'שגיאה במחיקת הליד', 'error');
            }
        } catch (error) {
            console.error('Delete error:', error);
            this.showToast('שגיאה במחיקת הליד', 'error');
        }
    }
    
    showToast(message, type = 'success') {
        // Create toast notification
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
}

// Toggle campaign info section
function toggleCampaignInfo() {
    const campaignInfo = document.getElementById('campaignInfo');
    const toggleIcon = document.getElementById('campaignToggleIcon');

    if (campaignInfo.style.display === 'none') {
        campaignInfo.style.display = 'block';
        toggleIcon.textContent = '▲';
    } else {
        campaignInfo.style.display = 'none';
        toggleIcon.textContent = '▼';
    }
}

// Initialize on page load
let UnifiedLeadManager;

// Fallback function for filter chips
function filterLeadsByType(type) {
    if (window.UnifiedLeadManager) {
        window.UnifiedLeadManager.filterLeadsByType(type);
    } else {
        console.log('UnifiedLeadManager not ready yet, retrying in 100ms...');
        setTimeout(() => filterLeadsByType(type), 100);
    }
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        window.UnifiedLeadManager = new UnifiedLeadManagerClass();
        console.log('🔍 DEBUGGING: UnifiedLeadManager initialized on DOMContentLoaded');
    });
} else {
    window.UnifiedLeadManager = new UnifiedLeadManagerClass();
    console.log('🔍 DEBUGGING: UnifiedLeadManager initialized immediately');
}

// Add animations and modal styles
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    
    /* Modal positioning - show at top */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 10000;
        overflow-y: auto;
        padding: 20px;
        box-sizing: border-box;
    }
    
    .modal .modal-content {
        background: linear-gradient(135deg, #fef7cd 0%, #fef3c7 100%);
        margin: 0 auto;
        border-radius: 10px;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px 10px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal .modal-header .close {
        font-size: 28px;
        cursor: pointer;
        background: none;
        border: none;
        color: white;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal .modal-body {
        padding: 20px;
        max-height: calc(90vh - 100px);
        overflow-y: auto;
    }
    
    /* Modal overlay for assignment and status modals */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
    }
    
    .modal-overlay .modal-content {
        background: linear-gradient(135deg, #fef7cd 0%, #fef3c7 100%);
        border-radius: 12px;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
        width: 100%;
        max-width: 500px;
    }
    
    .modal-overlay .modal-header {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-overlay .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 5px;
    }
    
    .modal-overlay .modal-body {
        padding: 25px;
    }
    
    .modal-overlay .modal-footer {
        padding: 20px 25px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    .btn-secondary {
        background: #6b7280;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    }
    
    .btn-secondary:hover {
        background: #4b5563;
    }
`;
document.head.appendChild(style);
</script>