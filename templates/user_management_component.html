<!-- Unified User Management Component -->
<!-- This component provides user management functionality for both admin and campaign manager roles -->

<!-- User Management Table -->
<div id="userManagementContainer" style="margin-top: 20px;">
    <div class="table-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div class="table-title" style="font-size: 1.4em; font-weight: bold; color: #2c3e50;">ğŸ‘¥ × ×™×”×•×œ ××©×ª××©×™×</div>
        <div class="user-actions">
            <button class="btn success" onclick="showUserModal()" style="background: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; margin: 0 5px;">â• ×”×•×¡×£ ××©×ª××© ×—×“×©</button>
            <button class="btn" onclick="loadUsers()" style="background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; margin: 0 5px;">ğŸ”„ ×¨×¢× ×Ÿ ×¨×©×™××”</button>
        </div>
    </div>
    
    <!-- Users Grid -->
    <div class="users-grid" id="usersContainer">
        <div class="loading">×˜×•×¢×Ÿ ××©×ª××©×™×...</div>
    </div>
</div>

<!-- Unified Add/Edit User Modal -->
<div id="userModal" class="user-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: scroll;">
    <div class="user-modal-content" style="background: white; margin: 30px auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; direction: rtl; margin-bottom: 50px;">
        <div class="user-modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; padding-bottom: 15px;">
            <h2 id="userModalTitle" style="color: #2c3e50; margin: 0;">×”×•×¡×£ ××©×ª××© ×—×“×©</h2>
            <button onclick="closeUserModal()" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 1.2em;">âœ–ï¸</button>
        </div>
        
        <form id="userForm" style="display: grid; gap: 20px;">
            <!-- Username -->
            <div class="form-field">
                <label for="userUsername" style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">×©× ××©×ª××©:</label>
                <input type="text" id="userUsername" name="username" required 
                       style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; direction: rtl; font-size: 16px;">
            </div>
            
            <!-- Full Name -->
            <div class="form-field">
                <label for="userFullName" style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">×©× ××œ×:</label>
                <input type="text" id="userFullName" name="full_name" required 
                       style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; direction: rtl; font-size: 16px;">
            </div>
            
            <!-- Email -->
            <div class="form-field">
                <label for="userEmail" style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">××™××™×™×œ:</label>
                <input type="email" id="userEmail" name="email" 
                       style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; direction: ltr; font-size: 16px;">
            </div>
            
            <!-- Phone Number -->
            <div class="form-field">
                <label for="userPhone" style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">ğŸ“± ×˜×œ×¤×•×Ÿ ×œ×”×ª×¨××•×ª WhatsApp:</label>
                <input type="tel" id="userPhone" name="phone" placeholder="050-1234567 ××• 0501234567"
                       style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; direction: ltr; font-size: 16px;">
                <small style="color: #6b7280; font-size: 0.9em; margin-top: 5px; display: block;">× ×“×¨×© ×œ×”×ª×¨××•×ª WhatsApp ×›×©××•×§×¦×™× ×œ×™×“×™×</small>
            </div>
            
            <!-- WhatsApp Notifications -->
            <div class="form-field">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="userWhatsappNotifications" name="whatsapp_notifications" checked
                           style="width: 18px; height: 18px;">
                    <span style="font-weight: bold; color: #2c3e50;">ğŸ’¬ ×§×‘×œ ×”×ª×¨××•×ª WhatsApp ×›×©××•×§×¦×™× ×œ×™×“×™×</span>
                </label>
                <small style="color: #6b7280; font-size: 0.9em; margin-top: 5px; display: block;">× ×™×ª×Ÿ ×œ×›×‘×•×ª ×”×ª×¨××•×ª ×‘×›×œ ×¢×ª</small>
            </div>
            
            <!-- Password -->
            <div class="form-field">
                <label for="userPassword" style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">×¡×™×¡××”:</label>
                <input type="text" id="userPassword" name="password" 
                       style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; direction: ltr; font-size: 16px; font-family: monospace;">
                <small style="color: #6b7280; font-size: 0.9em; margin-top: 5px; display: block;">×”×¡×™×¡××” ×ª×”×™×” × ×¨××™×ª ×œ×›×œ ×”×× ×”×œ×™×</small>
            </div>
            
            <!-- Current Password Display (for editing) -->
            <div class="form-field" id="currentPasswordField" style="display: none;">
                <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #059669;">×¡×™×¡××” × ×•×›×—×™×ª:</label>
                <div id="currentPasswordDisplay" style="background: #f0f9ff; padding: 12px; border-radius: 8px; border: 2px solid #3b82f6; font-family: monospace; color: #1e40af;"></div>
                <small style="color: #059669; font-size: 0.9em; margin-top: 5px; display: block;">×–×•×”×™ ×”×¡×™×¡××” ×”× ×•×›×—×™×ª. ×”×©××¨ ××ª ×”×©×“×” ×œ××¢×œ×” ×¨×™×§ ×›×“×™ ×œ× ×œ×©× ×•×ª.</small>
            </div>
            
            <!-- Department -->
            <div class="form-field">
                <label for="userDepartment" style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">××—×œ×§×”:</label>
                <select id="userDepartment" name="department" 
                        style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; direction: rtl; font-size: 16px;">
                    <option value="">×‘×—×¨ ××—×œ×§×”</option>
                    <option value="××˜×‘×—">××˜×‘×—</option>
                    <option value="×××¤×™×™×”">×××¤×™×™×”</option>
                    <option value="×¤×œ×•×¨">×¤×œ×•×¨</option>
                    <option value="×”× ×”×œ×”">×”× ×”×œ×”</option>
                    <option value="××—×–×§×” ×•× ×§×™×•×Ÿ">××—×–×§×” ×•× ×§×™×•×Ÿ</option>
                </select>
            </div>
            
            <!-- Role (Admin only) -->
            <div class="form-field" id="roleField">
                <label for="userRole" style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">×ª×¤×§×™×“:</label>
                <select id="userRole" name="role" 
                        style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; direction: rtl; font-size: 16px;">
                    <option value="user">××©×ª××©</option>
                    <option value="campaign_manager">×× ×”×œ ×§××¤×™×™×Ÿ</option>
                    <option value="admin">×× ×”×œ ××¢×¨×›×ª</option>
                </select>
            </div>
            
            <!-- Customer Assignment (Admin only) -->
            <div class="form-field" id="customerField">
                <label for="userCustomer" style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">×œ×§×•×—:</label>
                <select id="userCustomer" name="customer_id" 
                        style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; direction: rtl; font-size: 16px;">
                    <option value="">×˜×•×¢×Ÿ ×œ×§×•×—×•×ª...</option>
                </select>
            </div>
            
            <!-- Active Status -->
            <div class="form-field">
                <label style="display: flex; align-items: center; cursor: pointer; font-weight: bold; color: #2c3e50;">
                    <input type="checkbox" id="userActive" name="active" checked 
                           style="margin-left: 10px; transform: scale(1.2);">
                    ××©×ª××© ×¤×¢×™×œ
                </label>
            </div>
            
            <!-- Form Actions -->
            <div class="form-actions" style="display: flex; gap: 15px; justify-content: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                <button type="submit" style="background: #27ae60; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                    ğŸ’¾ ×©××•×¨ ××©×ª××©
                </button>
                <button type="button" onclick="closeUserModal()" style="background: #95a5a6; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                    âŒ ×‘×™×˜×•×œ
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Unified User Management JavaScript
let currentEditingUser = null;
let availableUsers = [];
let availableCustomers = [];
let userRole = '{{ session.get("role") }}'; // Get current user role

// Initialize component based on user role
function initUserManagement() {
    console.log('Initializing user management for role:', userRole);
    
    // Configure UI based on role
    if (userRole === 'campaign_manager') {
        // Hide admin-only fields for campaign managers
        document.getElementById('roleField').style.display = 'none';
        document.getElementById('customerField').style.display = 'none';
    } else if (userRole === 'admin') {
        // Load customers for admin
        loadCustomers();
    }
    
    // Load users
    loadUsers();
}

// Load available customers
async function loadCustomers() {
    // Customer field may be hidden for non-admins, but load anyway if called
    try {
        const response = await fetch('/admin/customers/api');
        const customers = await response.json();
        
        const customerSelect = document.getElementById('userCustomer');
        customerSelect.innerHTML = '<option value="">×‘×—×¨ ×œ×§×•×—</option>';
        
        customers.forEach(customer => {
            if (customer.active) {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                customerSelect.appendChild(option);
            }
        });
        
        availableCustomers = customers;
    } catch (error) {
        console.error('Error loading customers:', error);
    }
}

// Load users based on role
async function loadUsers() {
    try {
        document.getElementById('usersContainer').innerHTML = '<div class="loading">×˜×•×¢×Ÿ ××©×ª××©×™×...</div>';
        
        const response = await fetch('/admin/users/api');
        const data = await response.json();
        
        if (data.users && Array.isArray(data.users)) {
            availableUsers = data.users;
            renderUsersTable(availableUsers);
        } else if (data.error) {
            document.getElementById('usersContainer').innerHTML = `<div class="loading">×©×’×™××”: ${data.error}</div>`;
        } else {
            document.getElementById('usersContainer').innerHTML = '<div class="loading">×ª×’×•×‘×ª API ×œ× ×ª×§×™× ×”</div>';
        }
    } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersContainer').innerHTML = `<div class="loading">×©×’×™××”: ${error.message}</div>`;
    }
}

// Render users table
function renderUsersTable(users) {
    const container = document.getElementById('usersContainer');
    
    if (users.length === 0) {
        container.innerHTML = '<div class="loading">××™×Ÿ ××©×ª××©×™× ×œ×”×¦×’×”</div>';
        return;
    }
    
    const table = `
        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <thead>
                <tr style="background: #34495e; color: white;">
                    <th style="padding: 15px; text-align: right;">×¤×¢×•×œ×•×ª</th>
                    <th style="padding: 15px; text-align: right;">×¡×˜×˜×•×¡</th>
                    <th style="padding: 15px; text-align: right;">×ª×¤×§×™×“</th>
                    <th style="padding: 15px; text-align: right;">××—×œ×§×”</th>
                    <th style="padding: 15px; text-align: right;">××™××™×™×œ</th>
                    <th style="padding: 15px; text-align: right;">×©× ××œ×</th>
                    <th style="padding: 15px; text-align: right;">×©× ××©×ª××©</th>
                    ${userRole === 'admin' ? '<th style="padding: 15px; text-align: right;">×œ×§×•×—</th>' : ''}
                    <th style="padding: 15px; text-align: right;">×¡×™×¡××”</th>
                </tr>
            </thead>
            <tbody>
                ${users.map((user, index) => `
                    <tr style="border-bottom: 1px solid #ecf0f1; ${index % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;'}">
                        <td style="padding: 12px;">
                            <button onclick="editUser(${user.id})" style="background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin: 2px;">âœï¸ ×¢×¨×•×š</button>
                            <button onclick="toggleUserStatus(${user.id}, ${!user.active})" style="background: ${user.active ? '#e74c3c' : '#27ae60'}; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin: 2px;">
                                ${user.active ? 'âŒ ×”×©×‘×ª' : 'âœ… ×”×¤×¢×œ'}
                            </button>
                        </td>
                        <td style="padding: 12px;">
                            <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white; background: ${user.active ? '#27ae60' : '#95a5a6'};">
                                ${user.active ? '×¤×¢×™×œ' : '×œ× ×¤×¢×™×œ'}
                            </span>
                        </td>
                        <td style="padding: 12px;">${getRoleLabel(user.role)}</td>
                        <td style="padding: 12px;">${user.department || '×œ× ×¦×•×™×Ÿ'}</td>
                        <td style="padding: 12px; direction: ltr;">${user.email || '×œ× ×¦×•×™×Ÿ'}</td>
                        <td style="padding: 12px;"><strong>${user.full_name || '×œ× ×¦×•×™×Ÿ'}</strong></td>
                        <td style="padding: 12px;">${user.username}</td>
                        ${userRole === 'admin' ? `<td style="padding: 12px;">${user.customer_name || '×œ× ××©×•×™×š'}</td>` : ''}
                        <td style="padding: 12px; font-family: monospace; background: #f1f5f9; font-size: 14px;">${user.plain_password || '×œ× ×–××™×Ÿ'}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    container.innerHTML = table;
}

// Show user modal for create/edit
function showUserModal(userId = null) {
    currentEditingUser = null;

    // Always load customers when modal opens (for admins)
    if (userRole === 'admin' || userRole !== 'campaign_manager') {
        loadCustomers();
    }

    if (userId) {
        // Edit mode
        const user = availableUsers.find(u => u.id === userId);
        if (!user) {
            alert('××©×ª××© ×œ× × ××¦×');
            return;
        }
        
        currentEditingUser = user;
        document.getElementById('userModalTitle').textContent = '×¢×¨×•×š ××©×ª××©';
        
        // Populate form
        document.getElementById('userUsername').value = user.username;
        document.getElementById('userFullName').value = user.full_name || '';
        document.getElementById('userEmail').value = user.email || '';
        document.getElementById('userPhone').value = user.phone || '';
        document.getElementById('userPassword').value = ''; // Don't show current password
        document.getElementById('userDepartment').value = user.department || '';
        document.getElementById('userRole').value = user.role;
        document.getElementById('userActive').checked = user.active;
        document.getElementById('userWhatsappNotifications').checked = user.whatsapp_notifications !== false; // Default true
        
        if (userRole === 'admin') {
            document.getElementById('userCustomer').value = user.customer_id || '';
        }
        
        // Show current password
        if (user.plain_password) {
            document.getElementById('currentPasswordField').style.display = 'block';
            document.getElementById('currentPasswordDisplay').textContent = user.plain_password;
        }
    } else {
        // Create mode
        document.getElementById('userModalTitle').textContent = '×”×•×¡×£ ××©×ª××© ×—×“×©';
        document.getElementById('userForm').reset();
        document.getElementById('userActive').checked = true;
        document.getElementById('userWhatsappNotifications').checked = true; // Default notifications on
        document.getElementById('currentPasswordField').style.display = 'none';
        
        if (userRole === 'campaign_manager') {
            document.getElementById('userRole').value = 'user'; // Force user role for campaign managers
        }
    }
    
    document.getElementById('userModal').style.display = 'block';
}

// Close user modal
function closeUserModal() {
    document.getElementById('userModal').style.display = 'none';
    currentEditingUser = null;
}

// Edit specific user
function editUser(userId) {
    showUserModal(userId);
}

// Toggle user active status
async function toggleUserStatus(userId, newStatus) {
    try {
        const response = await fetch(`/admin/users/${userId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ active: newStatus })
        });
        
        const result = await response.json();
        if (result.status === 'success') {
            showToast(`××©×ª××© ${newStatus ? '×”×•×¤×¢×œ' : '×”×•×©×‘×ª'} ×‘×”×¦×œ×—×”`, 'success');
            loadUsers();
        } else {
            showToast(result.error || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”××©×ª××©', 'error');
        }
    } catch (error) {
        console.error('Error toggling user status:', error);
        showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
    }
}

// Handle form submission
document.getElementById('userForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        username: document.getElementById('userUsername').value.trim(),
        full_name: document.getElementById('userFullName').value.trim(),
        email: document.getElementById('userEmail').value.trim(),
        phone: document.getElementById('userPhone').value.trim(),
        password: document.getElementById('userPassword').value.trim(),
        department: document.getElementById('userDepartment').value,
        role: document.getElementById('userRole').value,
        active: document.getElementById('userActive').checked,
        whatsapp_notifications: document.getElementById('userWhatsappNotifications').checked
    };
    
    if (userRole === 'admin') {
        formData.customer_id = parseInt(document.getElementById('userCustomer').value) || null;
    }
    
    // Validation
    if (!formData.username || !formData.full_name) {
        alert('×©× ××©×ª××© ×•×©× ××œ× ×”× ×©×“×•×ª ×—×•×‘×”');
        return;
    }
    
    try {
        let response;
        if (currentEditingUser) {
            // Update existing user
            response = await fetch(`/admin/users/${currentEditingUser.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
        } else {
            // Create new user  
            if (!formData.password) {
                alert('×¡×™×¡××” × ×“×¨×©×ª ×¢×‘×•×¨ ××©×ª××© ×—×“×©');
                return;
            }
            response = await fetch('/admin/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
        }
        
        const result = await response.json();
        if (result.status === 'success') {
            showToast(currentEditingUser ? '××©×ª××© ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”' : '××©×ª××© × ×•×¡×£ ×‘×”×¦×œ×—×”', 'success');
            closeUserModal();
            loadUsers();
        } else {
            showToast(result.error || '×©×’×™××” ×‘×©××™×¨×ª ×”××©×ª××©', 'error');
        }
    } catch (error) {
        console.error('Error saving user:', error);
        showToast('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
    }
});

// Helper functions
function getRoleLabel(role) {
    const labels = {
        'admin': '×× ×”×œ ××¢×¨×›×ª',
        'campaign_manager': '×× ×”×œ ×§××¤×™×™×Ÿ',
        'user': '××©×ª××©'
    };
    return labels[role] || role;
}

// Toast notification function (if not already defined)
function showToast(message, type = 'success') {
    // Remove existing toast
    const existingToast = document.querySelector('.toast');
    if (existingToast) existingToast.remove();
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 10000;
        background: ${type === 'success' ? '#4CAF50' : '#f44336'};
        color: white; padding: 15px 25px; border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 16px; font-weight: bold;
        opacity: 0; transform: translateY(-20px); transition: all 0.3s ease;
    `;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
    }, 100);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-20px)';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initUserManagement);
} else {
    initUserManagement();
}
</script>